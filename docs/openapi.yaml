openapi: 3.1.0
info:
  title: Chat de Atendimento - API
  description: |
    API RESTful para sistema de atendimento ao cliente via WhatsApp.
    
    ## Funcionalidades Principais
    
    - üîê **Autentica√ß√£o JWT** com SQL Server
    - üí¨ **WhatsApp Business API** (Meta Cloud)
    - ü§ñ **Chatbot IA** com Google Gemini
    - ‚ö° **WebSocket** para tempo real
    - üìä **Dashboard** com m√©tricas
    
    ## Fluxo de Autentica√ß√£o
    
    1. Fa√ßa login via `POST /auth/login`
    2. Use o token retornado no header `Authorization: Bearer <token>`
    3. Token expira em 24 horas
    
  version: 2.0.0
  contact:
    name: Suporte API
    email: api@empresa.com
    url: https://empresa.com/suporte
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8000/api/v1
    description: Ambiente de Desenvolvimento
  - url: https://api.empresa.com/api/v1
    description: Ambiente de Produ√ß√£o

tags:
  - name: auth
    description: Endpoints de autentica√ß√£o e sess√£o
  - name: users
    description: Gerenciamento de usu√°rios
  - name: conversations
    description: Gerenciamento de conversas de atendimento
  - name: whatsapp
    description: Integra√ß√£o com WhatsApp Business API
  - name: chatbot
    description: Chatbot com Intelig√™ncia Artificial
  - name: dashboard
    description: Dashboard e m√©tricas em tempo real
  - name: health
    description: Verifica√ß√£o de sa√∫de do sistema

paths:
  /auth/login:
    post:
      tags:
        - auth
      summary: Autenticar usu√°rio
      description: |
        Autentica um usu√°rio e retorna um token JWT.
        
        **Rate Limit:** 5 tentativas / 15 minutos por IP
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
            example:
              email: usuario@email.com
              password: senha123
      responses:
        '200':
          description: Login bem-sucedido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: Credenciais inv√°lidas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Rate limit excedido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/logout:
    post:
      tags:
        - auth
      summary: Fazer logout
      description: Revoga o token JWT atual
      operationId: logout
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Logout bem-sucedido
        '401':
          description: Token inv√°lido

  /auth/me:
    get:
      tags:
        - auth
      summary: Obter usu√°rio atual
      description: Retorna informa√ß√µes do usu√°rio autenticado
      operationId: getCurrentUser
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Dados do usu√°rio
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /users:
    get:
      tags:
        - users
      summary: Listar usu√°rios
      description: Lista todos os usu√°rios (somente admin)
      operationId: listUsers
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          description: N√∫mero da p√°gina
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          description: Itens por p√°gina
          schema:
            type: integer
            default: 20
            maximum: 100
        - name: role
          in: query
          description: Filtrar por role
          schema:
            type: string
            enum: [admin, atendente, supervisor, user]
        - name: is_active
          in: query
          description: Filtrar por status
          schema:
            type: boolean
      responses:
        '200':
          description: Lista de usu√°rios
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserList'
        '403':
          description: Sem permiss√£o

    post:
      tags:
        - users
      summary: Criar usu√°rio
      description: Cria um novo usu√°rio (somente admin)
      operationId: createUser
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '201':
          description: Usu√°rio criado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Dados inv√°lidos
        '403':
          description: Sem permiss√£o

  /users/{user_id}:
    get:
      tags:
        - users
      summary: Obter usu√°rio
      operationId: getUser
      security:
        - bearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Dados do usu√°rio
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '404':
          description: Usu√°rio n√£o encontrado

    put:
      tags:
        - users
      summary: Atualizar usu√°rio
      operationId: updateUser
      security:
        - bearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: Usu√°rio atualizado
        '404':
          description: Usu√°rio n√£o encontrado

    delete:
      tags:
        - users
      summary: Desativar usu√°rio
      operationId: deleteUser
      security:
        - bearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Usu√°rio desativado
        '404':
          description: Usu√°rio n√£o encontrado

  /conversations:
    get:
      tags:
        - conversations
      summary: Listar conversas
      description: Lista conversas do atendente logado
      operationId: listConversations
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [queue, in_progress, resolved, closed]
        - name: channel
          in: query
          schema:
            type: string
            enum: [whatsapp, web, api]
        - name: assigned_to
          in: query
          schema:
            type: integer
        - name: start_date
          in: query
          schema:
            type: string
            format: date-time
        - name: end_date
          in: query
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Lista de conversas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationList'

  /conversations/{conversation_id}:
    get:
      tags:
        - conversations
      summary: Obter conversa
      description: Retorna detalhes de uma conversa com mensagens
      operationId: getConversation
      security:
        - bearerAuth: []
      parameters:
        - name: conversation_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Detalhes da conversa
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationDetail'
        '404':
          description: Conversa n√£o encontrada

  /conversations/{conversation_id}/messages:
    post:
      tags:
        - conversations
      summary: Enviar mensagem
      description: Envia uma mensagem em uma conversa
      operationId: sendMessage
      security:
        - bearerAuth: []
      parameters:
        - name: conversation_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendMessageRequest'
      responses:
        '200':
          description: Mensagem enviada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Message'

  /conversations/{conversation_id}/transfer:
    post:
      tags:
        - conversations
      summary: Transferir conversa
      operationId: transferConversation
      security:
        - bearerAuth: []
      parameters:
        - name: conversation_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransferRequest'
      responses:
        '200':
          description: Conversa transferida

  /conversations/{conversation_id}/close:
    post:
      tags:
        - conversations
      summary: Encerrar conversa
      operationId: closeConversation
      security:
        - bearerAuth: []
      parameters:
        - name: conversation_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CloseConversationRequest'
      responses:
        '200':
          description: Conversa encerrada

  /whatsapp/webhook:
    get:
      tags:
        - whatsapp
      summary: Verifica√ß√£o do webhook
      description: Endpoint de verifica√ß√£o (challenge) do WhatsApp
      operationId: verifyWebhook
      parameters:
        - name: hub.mode
          in: query
          required: true
          schema:
            type: string
        - name: hub.verify_token
          in: query
          required: true
          schema:
            type: string
        - name: hub.challenge
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Challenge aceito
        '403':
          description: Token de verifica√ß√£o inv√°lido

    post:
      tags:
        - whatsapp
      summary: Webhook de eventos
      description: Recebe eventos do WhatsApp Business API
      operationId: handleWebhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Evento processado

  /whatsapp/send:
    post:
      tags:
        - whatsapp
      summary: Enviar mensagem
      description: Envia mensagem WhatsApp
      operationId: sendWhatsAppMessage
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WhatsAppMessageRequest'
      responses:
        '200':
          description: Mensagem enviada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WhatsAppMessageResponse'

  /whatsapp/send-template:
    post:
      tags:
        - whatsapp
      summary: Enviar template
      description: Envia template pr√©-aprovado pelo WhatsApp
      operationId: sendWhatsAppTemplate
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WhatsAppTemplateRequest'
      responses:
        '200':
          description: Template enviado

  /chatbot/message:
    post:
      tags:
        - chatbot
      summary: Processar mensagem
      description: Processa mensagem com IA (Google Gemini)
      operationId: processChatbotMessage
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatbotMessageRequest'
      responses:
        '200':
          description: Resposta do chatbot
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatbotResponse'

  /chatbot/escalate:
    post:
      tags:
        - chatbot
      summary: Escalar conversa
      description: Escala conversa para atendente humano
      operationId: escalateConversation
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EscalateRequest'
      responses:
        '200':
          description: Conversa escalada

  /dashboard/metrics:
    get:
      tags:
        - dashboard
      summary: M√©tricas em tempo real
      operationId: getDashboardMetrics
      security:
        - bearerAuth: []
      responses:
        '200':
          description: M√©tricas do sistema
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DashboardMetrics'

  /dashboard/agents:
    get:
      tags:
        - dashboard
      summary: Status dos atendentes
      operationId: getAgentsStatus
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Lista de atendentes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentsList'

  /dashboard/queue:
    get:
      tags:
        - dashboard
      summary: Fila de espera
      operationId: getQueue
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Fila de atendimento
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueueStatus'

  /health:
    get:
      tags:
        - health
      summary: Verificar sa√∫de
      description: Retorna status de sa√∫de da aplica√ß√£o
      operationId: healthCheck
      responses:
        '200':
          description: Sistema saud√°vel
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Token JWT obtido via /auth/login

  schemas:
    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: usuario@email.com
        password:
          type: string
          format: password
          minLength: 8
          example: senha123

    LoginResponse:
      type: object
      properties:
        access_token:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        token_type:
          type: string
          example: bearer
        expires_in:
          type: integer
          example: 86400
        user:
          $ref: '#/components/schemas/User'

    User:
      type: object
      properties:
        id:
          type: integer
          example: 1
        email:
          type: string
          format: email
          example: usuario@email.com
        nome:
          type: string
          example: Jo√£o Silva
        role:
          type: string
          enum: [admin, atendente, supervisor, user]
          example: atendente
        is_active:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time

    UserList:
      type: object
      properties:
        users:
          type: array
          items:
            $ref: '#/components/schemas/User'
        total:
          type: integer
        page:
          type: integer
        pages:
          type: integer

    CreateUserRequest:
      type: object
      required:
        - email
        - password
        - nome
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
        nome:
          type: string
        role:
          type: string
          enum: [admin, atendente, supervisor, user]
          default: user

    UpdateUserRequest:
      type: object
      properties:
        nome:
          type: string
        role:
          type: string
        is_active:
          type: boolean

    Conversation:
      type: object
      properties:
        id:
          type: string
          format: uuid
        customer_phone:
          type: string
          example: "+5511999999999"
        customer_name:
          type: string
        status:
          type: string
          enum: [queue, in_progress, resolved, closed]
        channel:
          type: string
          enum: [whatsapp, web, api]
        assigned_to:
          type: integer
        started_at:
          type: string
          format: date-time
        last_message_at:
          type: string
          format: date-time
        messages_count:
          type: integer

    ConversationList:
      type: object
      properties:
        conversations:
          type: array
          items:
            $ref: '#/components/schemas/Conversation'
        total:
          type: integer

    ConversationDetail:
      allOf:
        - $ref: '#/components/schemas/Conversation'
        - type: object
          properties:
            messages:
              type: array
              items:
                $ref: '#/components/schemas/Message'

    Message:
      type: object
      properties:
        id:
          type: string
        direction:
          type: string
          enum: [incoming, outgoing]
        content:
          type: string
        type:
          type: string
          enum: [text, image, document, template]
        timestamp:
          type: string
          format: date-time
        status:
          type: string
          enum: [sent, delivered, read, failed]
        sent_by:
          type: string
          enum: [agent, bot, customer]

    SendMessageRequest:
      type: object
      required:
        - content
      properties:
        content:
          type: string
        type:
          type: string
          enum: [text, image, document]
          default: text

    TransferRequest:
      type: object
      required:
        - to_agent_id
      properties:
        to_agent_id:
          type: integer
        reason:
          type: string

    CloseConversationRequest:
      type: object
      properties:
        resolution:
          type: string
          enum: [resolved, unresolved, abandoned]
        notes:
          type: string

    WhatsAppMessageRequest:
      type: object
      required:
        - to
        - type
        - content
      properties:
        to:
          type: string
          example: "+5511999999999"
        type:
          type: string
          enum: [text, image, document]
        content:
          oneOf:
            - type: string
            - type: object

    WhatsAppMessageResponse:
      type: object
      properties:
        message_id:
          type: string
        status:
          type: string

    WhatsAppTemplateRequest:
      type: object
      required:
        - to
        - template_name
      properties:
        to:
          type: string
        template_name:
          type: string
        language:
          type: string
          default: pt_BR
        components:
          type: array
          items:
            type: object

    ChatbotMessageRequest:
      type: object
      required:
        - conversation_id
        - message
      properties:
        conversation_id:
          type: string
          format: uuid
        message:
          type: string
        context:
          type: object
          additionalProperties: true

    ChatbotResponse:
      type: object
      properties:
        response:
          type: string
        intent:
          type: string
        confidence:
          type: number
          format: float
        should_transfer:
          type: boolean
        suggested_actions:
          type: array
          items:
            type: string

    EscalateRequest:
      type: object
      required:
        - conversation_id
      properties:
        conversation_id:
          type: string
          format: uuid
        reason:
          type: string

    DashboardMetrics:
      type: object
      properties:
        conversations:
          type: object
          properties:
            active:
              type: integer
            in_queue:
              type: integer
            resolved_today:
              type: integer
        agents:
          type: object
          properties:
            online:
              type: integer
            busy:
              type: integer
            available:
              type: integer
        performance:
          type: object
          properties:
            avg_response_time_seconds:
              type: number
            avg_resolution_time_minutes:
              type: number
            satisfaction_rate:
              type: number

    AgentsList:
      type: object
      properties:
        agents:
          type: array
          items:
            $ref: '#/components/schemas/AgentStatus'

    AgentStatus:
      type: object
      properties:
        id:
          type: integer
        nome:
          type: string
        status:
          type: string
          enum: [online, offline, busy, away]
        current_conversations:
          type: integer
        max_conversations:
          type: integer
        avg_response_time:
          type: number

    QueueStatus:
      type: object
      properties:
        queue:
          type: array
          items:
            $ref: '#/components/schemas/QueueItem'
        total_in_queue:
          type: integer
        avg_wait_time_minutes:
          type: number

    QueueItem:
      type: object
      properties:
        position:
          type: integer
        customer_phone:
          type: string
        customer_name:
          type: string
        waiting_since:
          type: string
          format: date-time
        estimated_wait_minutes:
          type: number
        priority:
          type: string
          enum: [low, normal, high, urgent]

    HealthStatus:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        version:
          type: string
        timestamp:
          type: string
          format: date-time
        services:
          type: object
          additionalProperties:
            type: string

    ErrorResponse:
      type: object
      properties:
        detail:
          type: string
        error_code:
          type: string
        field:
          type: string

security:
  - bearerAuth: []
