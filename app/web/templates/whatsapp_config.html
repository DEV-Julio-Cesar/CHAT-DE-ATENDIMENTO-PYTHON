<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp - CIANET PROVEDOR</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body style="margin:0;font-family:'Segoe UI',system-ui,sans-serif;background:#f1f5f9;min-height:100vh">

<!-- Layout -->
<div style="display:flex;min-height:100vh">
    
    <!-- Sidebar -->
    <aside style="width:260px;background:linear-gradient(180deg,#166534 0%,#22c55e 100%);color:white;position:fixed;height:100vh;box-shadow:4px 0 20px rgba(0,0,0,0.15)">
        <div style="padding:24px;border-bottom:1px solid rgba(255,255,255,0.15)">
            <div style="display:flex;align-items:center;gap:12px">
                <div style="width:48px;height:48px;background:linear-gradient(135deg,#f97316,#ea580c);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:0 6px 15px rgba(249,115,22,0.4)">
                    <i class="bi bi-headset"></i>
                </div>
                <div>
                    <div style="font-size:18px;font-weight:700">CIANET</div>
                    <div style="font-size:11px;opacity:0.8">Atendimento Inteligente</div>
                </div>
            </div>
        </div>
        
        <nav style="padding:20px 14px">
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,0.5);padding:0 12px;margin-bottom:12px">Principal</div>
            <a href="/dashboard" style="display:flex;align-items:center;gap:12px;padding:12px 16px;color:rgba(255,255,255,0.85);text-decoration:none;border-radius:12px;margin-bottom:4px;transition:all 0.2s">
                <i class="bi bi-grid-1x2-fill"></i><span>Dashboard</span>
            </a>
            <a href="/chat" style="display:flex;align-items:center;gap:12px;padding:12px 16px;color:rgba(255,255,255,0.85);text-decoration:none;border-radius:12px;margin-bottom:4px;transition:all 0.2s">
                <i class="bi bi-chat-dots-fill"></i><span>Atendimentos</span>
            </a>
            <a href="/whatsapp" style="display:flex;align-items:center;gap:12px;padding:12px 16px;color:white;text-decoration:none;border-radius:12px;margin-bottom:4px;background:linear-gradient(135deg,#f97316,#ea580c);box-shadow:0 6px 15px rgba(249,115,22,0.35)">
                <i class="bi bi-whatsapp"></i><span>WhatsApp</span>
            </a>
            
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,0.5);padding:0 12px;margin:20px 0 12px">Gest√£o</div>
            <a href="/customers" style="display:flex;align-items:center;gap:12px;padding:12px 16px;color:rgba(255,255,255,0.85);text-decoration:none;border-radius:12px;margin-bottom:4px">
                <i class="bi bi-people-fill"></i><span>Clientes</span>
            </a>
            <a href="/chatbot-admin" style="display:flex;align-items:center;gap:12px;padding:12px 16px;color:rgba(255,255,255,0.85);text-decoration:none;border-radius:12px;margin-bottom:4px">
                <i class="bi bi-robot"></i><span>Treinar Chatbot</span>
            </a>
            
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,0.5);padding:0 12px;margin:20px 0 12px">Sistema</div>
            <a href="/login" onclick="localStorage.clear();sessionStorage.clear()" style="display:flex;align-items:center;gap:12px;padding:12px 16px;color:rgba(255,255,255,0.85);text-decoration:none;border-radius:12px">
                <i class="bi bi-box-arrow-left"></i><span>Sair</span>
            </a>
        </nav>
    </aside>
    
    <!-- Main Content -->
    <main style="flex:1;margin-left:260px;padding:32px">
        
        <!-- Header -->
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:32px">
            <div>
                <h1 style="font-size:28px;font-weight:700;color:#1e293b;margin:0 0 8px 0">
                    <i class="bi bi-whatsapp" style="color:#25d366;margin-right:10px"></i>
                    Configura√ß√£o WhatsApp
                </h1>
                <p style="color:#64748b;margin:0">Conecte e gerencie seus canais do WhatsApp Business</p>
            </div>
        </div>
        
        <!-- Status Card -->
        <div id="statusCard" style="background:white;border-radius:20px;padding:28px;margin-bottom:28px;box-shadow:0 4px 20px rgba(0,0,0,0.08)">
            <div style="display:flex;align-items:center;gap:20px">
                <div id="statusIcon" style="width:70px;height:70px;border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:32px;background:linear-gradient(135deg,#fef3c7,#fde68a);color:#f59e0b">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                </div>
                <div style="flex:1">
                    <h3 id="statusTitle" style="font-size:20px;font-weight:700;color:#1e293b;margin:0 0 6px 0">WhatsApp N√£o Configurado</h3>
                    <p id="statusDesc" style="color:#64748b;margin:0">Configure suas credenciais para come√ßar a receber mensagens</p>
                </div>
                <div id="statusBadge" style="padding:10px 20px;border-radius:30px;font-size:14px;font-weight:600;background:#fef3c7;color:#b45309">
                    <i class="bi bi-circle-fill" style="font-size:8px;margin-right:8px"></i>Desconectado
                </div>
            </div>
        </div>
        
        <!-- QR Code Section -->
        <div style="background:white;border-radius:20px;padding:28px;margin-bottom:28px;box-shadow:0 4px 20px rgba(0,0,0,0.08)">
            <div style="display:flex;gap:32px;align-items:center">
                
                <!-- QR Code Display -->
                <div style="flex-shrink:0">
                    <div id="qrCodeContainer" style="width:280px;height:280px;background:linear-gradient(135deg,#f8fafc,#f1f5f9);border-radius:20px;display:flex;align-items:center;justify-content:center;border:3px dashed #e2e8f0;position:relative;overflow:hidden">
                        <!-- QR Code placeholder -->
                        <div id="qrPlaceholder" style="text-align:center;padding:20px">
                            <i class="bi bi-qr-code" style="font-size:64px;color:#cbd5e1;display:block;margin-bottom:12px"></i>
                            <p style="color:#94a3b8;font-size:14px;margin:0">Clique para gerar<br>QR Code</p>
                        </div>
                        <!-- QR Code Image -->
                        <img id="qrImage" style="display:none;width:250px;height:250px;border-radius:12px" alt="QR Code WhatsApp">
                        <!-- Loading spinner -->
                        <div id="qrLoading" style="display:none;text-align:center">
                            <i class="bi bi-arrow-repeat" style="font-size:48px;color:#22c55e;animation:spin 1s linear infinite"></i>
                            <p style="color:#64748b;font-size:14px;margin-top:12px">Conectando ao WhatsApp...</p>
                            <p style="color:#94a3b8;font-size:12px;margin-top:4px">Isso pode levar alguns segundos</p>
                        </div>
                        <!-- Connected state -->
                        <div id="qrConnected" style="display:none;text-align:center">
                            <i class="bi bi-check-circle-fill" style="font-size:64px;color:#22c55e;display:block;margin-bottom:12px"></i>
                            <p style="color:#16a34a;font-size:16px;font-weight:600;margin:0">Conectado!</p>
                            <div id="connectedInfo"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Instructions -->
                <div style="flex:1">
                    <div style="display:flex;align-items:center;gap:14px;margin-bottom:20px">
                        <div style="width:52px;height:52px;background:linear-gradient(135deg,#25d366,#128c7e);border-radius:16px;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 20px rgba(37,211,102,0.3)">
                            <i class="bi bi-whatsapp" style="color:white;font-size:26px"></i>
                        </div>
                        <div>
                            <h3 style="font-size:20px;font-weight:700;color:#1e293b;margin:0">Conex√£o via QR Code</h3>
                            <p style="font-size:13px;color:#64748b;margin:0">Conecte seu WhatsApp em segundos</p>
                        </div>
                    </div>
                    
                    <div style="space-y:16px">
                        <div style="display:flex;align-items:flex-start;gap:14px;margin-bottom:16px">
                            <div style="width:32px;height:32px;background:linear-gradient(135deg,#22c55e,#16a34a);border-radius:10px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:14px;flex-shrink:0">1</div>
                            <div>
                                <p style="font-size:14px;color:#1e293b;font-weight:600;margin:0 0 4px 0">Abra o WhatsApp no celular</p>
                                <p style="font-size:13px;color:#64748b;margin:0">Toque nos tr√™s pontos ‚ãÆ e selecione "Aparelhos conectados"</p>
                            </div>
                        </div>
                        
                        <div style="display:flex;align-items:flex-start;gap:14px;margin-bottom:16px">
                            <div style="width:32px;height:32px;background:linear-gradient(135deg,#f97316,#ea580c);border-radius:10px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:14px;flex-shrink:0">2</div>
                            <div>
                                <p style="font-size:14px;color:#1e293b;font-weight:600;margin:0 0 4px 0">Toque em "Conectar um aparelho"</p>
                                <p style="font-size:13px;color:#64748b;margin:0">Use sua biometria ou PIN para desbloquear</p>
                            </div>
                        </div>
                        
                        <div style="display:flex;align-items:flex-start;gap:14px;margin-bottom:24px">
                            <div style="width:32px;height:32px;background:linear-gradient(135deg,#3b82f6,#1d4ed8);border-radius:10px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:14px;flex-shrink:0">3</div>
                            <div>
                                <p style="font-size:14px;color:#1e293b;font-weight:600;margin:0 0 4px 0">Escaneie o QR Code</p>
                                <p style="font-size:13px;color:#64748b;margin:0">Aponte a c√¢mera do celular para o c√≥digo ao lado</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:12px">
                        <button onclick="generateQRCode()" id="generateQrBtn" style="flex:1;padding:16px 24px;background:linear-gradient(135deg,#25d366,#128c7e);color:white;border:none;border-radius:14px;font-size:15px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:all 0.2s"
                            onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 10px 25px rgba(37,211,102,0.35)'"
                            onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
                            <i class="bi bi-qr-code-scan"></i>Gerar QR Code
                        </button>
                        <button onclick="refreshQRCode()" id="refreshQrBtn" style="padding:16px 20px;background:#f1f5f9;border:2px solid #e2e8f0;border-radius:14px;cursor:pointer;transition:all 0.2s"
                            onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f1f5f9'">
                            <i class="bi bi-arrow-clockwise" style="font-size:20px;color:#64748b"></i>
                        </button>
                    </div>
                    
                    <p style="font-size:12px;color:#94a3b8;margin-top:14px;display:flex;align-items:center;gap:6px">
                        <i class="bi bi-shield-check"></i>
                        Conex√£o criptografada de ponta a ponta
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Config Cards Grid -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:28px">
            
            <!-- Credenciais Meta -->
            <div style="background:white;border-radius:20px;padding:28px;box-shadow:0 4px 20px rgba(0,0,0,0.08)">
                <div style="display:flex;align-items:center;gap:14px;margin-bottom:24px">
                    <div style="width:48px;height:48px;background:linear-gradient(135deg,#3b82f6,#1d4ed8);border-radius:14px;display:flex;align-items:center;justify-content:center">
                        <i class="bi bi-key-fill" style="color:white;font-size:22px"></i>
                    </div>
                    <div>
                        <h3 style="font-size:18px;font-weight:700;color:#1e293b;margin:0">Credenciais Meta</h3>
                        <p style="font-size:13px;color:#64748b;margin:0">WhatsApp Business API</p>
                    </div>
                </div>
                
                <form id="credentialsForm">
                    <div style="margin-bottom:18px">
                        <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:8px">
                            <i class="bi bi-shield-lock" style="margin-right:6px"></i>Access Token
                        </label>
                        <input type="password" id="accessToken" placeholder="EAAxxxxxxxx..." 
                            style="width:100%;padding:14px 16px;border:2px solid #e2e8f0;border-radius:12px;font-size:14px;box-sizing:border-box;transition:all 0.2s"
                            onfocus="this.style.borderColor='#22c55e';this.style.boxShadow='0 0 0 4px rgba(34,197,94,0.1)'"
                            onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                    </div>
                    
                    <div style="margin-bottom:18px">
                        <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:8px">
                            <i class="bi bi-phone" style="margin-right:6px"></i>Phone Number ID
                        </label>
                        <input type="text" id="phoneNumberId" placeholder="1234567890123456" 
                            style="width:100%;padding:14px 16px;border:2px solid #e2e8f0;border-radius:12px;font-size:14px;box-sizing:border-box;transition:all 0.2s"
                            onfocus="this.style.borderColor='#22c55e';this.style.boxShadow='0 0 0 4px rgba(34,197,94,0.1)'"
                            onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                    </div>
                    
                    <div style="margin-bottom:20px">
                        <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:8px">
                            <i class="bi bi-hash" style="margin-right:6px"></i>Business Account ID
                        </label>
                        <input type="text" id="businessAccountId" placeholder="9876543210987654" 
                            style="width:100%;padding:14px 16px;border:2px solid #e2e8f0;border-radius:12px;font-size:14px;box-sizing:border-box;transition:all 0.2s"
                            onfocus="this.style.borderColor='#22c55e';this.style.boxShadow='0 0 0 4px rgba(34,197,94,0.1)'"
                            onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                    </div>
                    
                    <button type="submit" style="width:100%;padding:16px;background:linear-gradient(135deg,#22c55e,#16a34a);color:white;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:all 0.2s"
                        onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 10px 25px rgba(34,197,94,0.3)'"
                        onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
                        <i class="bi bi-save"></i>Salvar Credenciais
                    </button>
                </form>
            </div>
            
            <!-- Webhook Config -->
            <div style="background:white;border-radius:20px;padding:28px;box-shadow:0 4px 20px rgba(0,0,0,0.08)">
                <div style="display:flex;align-items:center;gap:14px;margin-bottom:24px">
                    <div style="width:48px;height:48px;background:linear-gradient(135deg,#f97316,#ea580c);border-radius:14px;display:flex;align-items:center;justify-content:center">
                        <i class="bi bi-link-45deg" style="color:white;font-size:22px"></i>
                    </div>
                    <div>
                        <h3 style="font-size:18px;font-weight:700;color:#1e293b;margin:0">Webhook</h3>
                        <p style="font-size:13px;color:#64748b;margin:0">Configure no Meta Business</p>
                    </div>
                </div>
                
                <div style="margin-bottom:18px">
                    <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:8px">
                        <i class="bi bi-globe" style="margin-right:6px"></i>URL do Webhook
                    </label>
                    <div style="display:flex;gap:10px">
                        <input type="text" id="webhookUrl" readonly value="https://seudominio.com/api/v1/whatsapp/webhook" 
                            style="flex:1;padding:14px 16px;border:2px solid #e2e8f0;border-radius:12px;font-size:13px;background:#f8fafc;color:#475569">
                        <button onclick="copyWebhook()" style="padding:14px 18px;background:#f1f5f9;border:2px solid #e2e8f0;border-radius:12px;cursor:pointer;transition:all 0.2s"
                            onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f1f5f9'">
                            <i class="bi bi-clipboard" style="font-size:18px;color:#64748b"></i>
                        </button>
                    </div>
                </div>
                
                <div style="margin-bottom:20px">
                    <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:8px">
                        <i class="bi bi-shield-check" style="margin-right:6px"></i>Verify Token
                    </label>
                    <div style="display:flex;gap:10px">
                        <input type="text" id="verifyToken" readonly value="cianet_whatsapp_verify_2026" 
                            style="flex:1;padding:14px 16px;border:2px solid #e2e8f0;border-radius:12px;font-size:14px;background:#f8fafc;color:#475569">
                        <button onclick="copyVerifyToken()" style="padding:14px 18px;background:#f1f5f9;border:2px solid #e2e8f0;border-radius:12px;cursor:pointer;transition:all 0.2s"
                            onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f1f5f9'">
                            <i class="bi bi-clipboard" style="font-size:18px;color:#64748b"></i>
                        </button>
                    </div>
                </div>
                
                <button onclick="testConnection()" id="testBtn" style="width:100%;padding:16px;background:linear-gradient(135deg,#f97316,#ea580c);color:white;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:all 0.2s"
                    onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 10px 25px rgba(249,115,22,0.3)'"
                    onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
                    <i class="bi bi-arrow-repeat"></i>Testar Conex√£o
                </button>
            </div>
        </div>
        
        <!-- Instructions -->
        <div style="background:linear-gradient(135deg,#ecfdf5,#d1fae5);border:2px solid #a7f3d0;border-radius:20px;padding:28px">
            <div style="display:flex;align-items:center;gap:14px;margin-bottom:20px">
                <div style="width:48px;height:48px;background:white;border-radius:14px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(34,197,94,0.15)">
                    <i class="bi bi-info-circle-fill" style="color:#22c55e;font-size:24px"></i>
                </div>
                <h3 style="font-size:18px;font-weight:700;color:#166534;margin:0">Como Configurar</h3>
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px">
                <div style="background:white;padding:20px;border-radius:14px">
                    <div style="width:36px;height:36px;background:linear-gradient(135deg,#22c55e,#16a34a);border-radius:10px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;margin-bottom:12px">1</div>
                    <h4 style="font-size:15px;font-weight:600;color:#1e293b;margin:0 0 8px 0">Acesse o Meta Business</h4>
                    <p style="font-size:13px;color:#64748b;margin:0;line-height:1.5">V√° em <a href="https://business.facebook.com" target="_blank" style="color:#22c55e">business.facebook.com</a> e acesse seu app</p>
                </div>
                
                <div style="background:white;padding:20px;border-radius:14px">
                    <div style="width:36px;height:36px;background:linear-gradient(135deg,#f97316,#ea580c);border-radius:10px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;margin-bottom:12px">2</div>
                    <h4 style="font-size:15px;font-weight:600;color:#1e293b;margin:0 0 8px 0">Copie as Credenciais</h4>
                    <p style="font-size:13px;color:#64748b;margin:0;line-height:1.5">Em WhatsApp > API Setup, copie o Token e Phone Number ID</p>
                </div>
                
                <div style="background:white;padding:20px;border-radius:14px">
                    <div style="width:36px;height:36px;background:linear-gradient(135deg,#3b82f6,#1d4ed8);border-radius:10px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;margin-bottom:12px">3</div>
                    <h4 style="font-size:15px;font-weight:600;color:#1e293b;margin:0 0 8px 0">Configure o Webhook</h4>
                    <p style="font-size:13px;color:#64748b;margin:0;line-height:1.5">Cole a URL e Verify Token no Meta e assine os eventos</p>
                </div>
            </div>
        </div>
        
    </main>
</div>

<!-- Toast -->
<div id="toast" style="display:none;position:fixed;bottom:30px;right:30px;padding:16px 24px;border-radius:14px;color:white;font-weight:500;z-index:1000;box-shadow:0 10px 30px rgba(0,0,0,0.2)"></div>

<script>
// Configura√ß√£o do servi√ßo WhatsApp Web
const WHATSAPP_SERVICE_URL = 'http://localhost:3001';

// Vari√°veis globais
let qrCheckInterval = null;
let sessionId = null;

// Verificar autentica√ß√£o
const token = localStorage.getItem('access_token') || sessionStorage.getItem('access_token');
if (!token) window.location.href = '/login';

function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.style.background = type === 'success' ? 'linear-gradient(135deg,#22c55e,#16a34a)' : 'linear-gradient(135deg,#ef4444,#dc2626)';
    toast.style.display = 'block';
    setTimeout(() => toast.style.display = 'none', 4000);
}

function copyWebhook() {
    navigator.clipboard.writeText(document.getElementById('webhookUrl').value);
    showToast('URL copiada!');
}

function copyVerifyToken() {
    navigator.clipboard.writeText(document.getElementById('verifyToken').value);
    showToast('Token copiado!');
}

// Carregar configura√ß√£o atual
async function loadConfig() {
    try {
        const res = await fetch('/api/v1/whatsapp/config', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.ok) {
            const data = await res.json();
            if (data.configured) {
                document.getElementById('phoneNumberId').value = data.phone_number_id || '';
                document.getElementById('businessAccountId').value = data.business_account_id || '';
                updateStatus(true);
            }
        }
    } catch (e) {
        console.log('Config not loaded:', e);
    }
}

function updateStatus(connected) {
    const icon = document.getElementById('statusIcon');
    const title = document.getElementById('statusTitle');
    const desc = document.getElementById('statusDesc');
    const badge = document.getElementById('statusBadge');
    
    if (connected) {
        icon.style.background = 'linear-gradient(135deg,#dcfce7,#bbf7d0)';
        icon.style.color = '#22c55e';
        icon.innerHTML = '<i class="bi bi-check-circle-fill"></i>';
        title.textContent = 'WhatsApp Conectado';
        desc.textContent = 'Seu canal est√° ativo e recebendo mensagens';
        badge.style.background = '#dcfce7';
        badge.style.color = '#16a34a';
        badge.innerHTML = '<i class="bi bi-circle-fill" style="font-size:8px;margin-right:8px"></i>Conectado';
    }
}

// Salvar credenciais
document.getElementById('credentialsForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        access_token: document.getElementById('accessToken').value,
        phone_number_id: document.getElementById('phoneNumberId').value,
        business_account_id: document.getElementById('businessAccountId').value
    };
    
    try {
        const res = await fetch('/api/v1/whatsapp/config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(data)
        });
        
        if (res.ok) {
            showToast('Credenciais salvas com sucesso!');
            updateStatus(true);
        } else {
            showToast('Erro ao salvar credenciais', 'error');
        }
    } catch (e) {
        showToast('Erro de conex√£o', 'error');
    }
});

// Testar conex√£o
async function testConnection() {
    const btn = document.getElementById('testBtn');
    btn.innerHTML = '<i class="bi bi-arrow-repeat" style="animation:spin 1s linear infinite"></i> Testando...';
    btn.disabled = true;
    
    try {
        const res = await fetch('/api/v1/whatsapp/test', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (res.ok) {
            showToast('Conex√£o estabelecida com sucesso!');
            updateStatus(true);
        } else {
            showToast('Falha na conex√£o. Verifique as credenciais.', 'error');
        }
    } catch (e) {
        showToast('Erro ao testar conex√£o', 'error');
    }
    
    btn.innerHTML = '<i class="bi bi-arrow-repeat"></i>Testar Conex√£o';
    btn.disabled = false;
}

// ========== QR CODE FUNCTIONS ==========

async function generateQRCode() {
    const btn = document.getElementById('generateQrBtn');
    const placeholder = document.getElementById('qrPlaceholder');
    const loading = document.getElementById('qrLoading');
    const qrImage = document.getElementById('qrImage');
    const connected = document.getElementById('qrConnected');
    
    // Mostrar loading
    placeholder.style.display = 'none';
    qrImage.style.display = 'none';
    connected.style.display = 'none';
    loading.style.display = 'block';
    btn.disabled = true;
    
    try {
        // Solicitar QR Code do servi√ßo WhatsApp Web (Node.js)
        const res = await fetch(`${WHATSAPP_SERVICE_URL}/session/create`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sessionId: 'cianet_main' })
        });
        
        const data = await res.json();
        
        if (data.success) {
            sessionId = data.sessionId;
            
            if (data.status === 'connected' || data.status === 'already_connected') {
                // J√° est√° conectado
                onWhatsAppConnected(data.info);
            } else if (data.qrCode) {
                // Mostrar QR Code
                loading.style.display = 'none';
                qrImage.style.display = 'block';
                qrImage.src = data.qrCode;
                
                showToast('QR Code gerado! Escaneie com seu celular.');
                startConnectionCheck();
            }
        } else {
            throw new Error(data.error || 'Falha ao gerar QR Code');
        }
        
    } catch (e) {
        console.error('Erro ao conectar ao servi√ßo WhatsApp:', e);
        loading.style.display = 'none';
        placeholder.style.display = 'block';
        showToast('Erro: Servi√ßo WhatsApp n√£o est√° rodando. Execute "npm start" na pasta whatsapp-service', 'error');
    }
    
    btn.disabled = false;
}

function refreshQRCode() {
    stopConnectionCheck();
    generateQRCode();
}

function startConnectionCheck() {
    // Verificar conex√£o a cada 2 segundos
    qrCheckInterval = setInterval(async () => {
        try {
            const res = await fetch(`${WHATSAPP_SERVICE_URL}/session/${sessionId}/status`);
            const data = await res.json();
            
            if (data.connected) {
                onWhatsAppConnected(data.info);
            } else if (data.qrStatus === 'auth_failure') {
                showToast('Falha na autentica√ß√£o. Tente novamente.', 'error');
                resetQRCode();
            }
        } catch (e) {
            console.log('Verificando conex√£o...');
        }
    }, 2000);
    
    // Timeout de 2 minutos para o QR code
    setTimeout(() => {
        if (qrCheckInterval) {
            showToast('QR Code expirado. Gere um novo.', 'error');
            resetQRCode();
        }
    }, 120000);
}

function stopConnectionCheck() {
    if (qrCheckInterval) {
        clearInterval(qrCheckInterval);
        qrCheckInterval = null;
    }
}

function onWhatsAppConnected(info) {
    stopConnectionCheck();
    
    const qrImage = document.getElementById('qrImage');
    const connected = document.getElementById('qrConnected');
    const connectedInfo = document.getElementById('connectedInfo');
    
    qrImage.style.display = 'none';
    connected.style.display = 'block';
    
    if (info && connectedInfo) {
        connectedInfo.innerHTML = `
            <p style="font-size:14px;color:#16a34a;margin:8px 0 0 0">
                <strong>${info.pushname || 'WhatsApp'}</strong><br>
                <span style="font-size:12px;color:#64748b">${info.wid?.user || ''}</span>
            </p>
        `;
    }
    
    updateStatus(true);
    showToast('WhatsApp conectado com sucesso! üéâ');
}

function resetQRCode() {
    stopConnectionCheck();
    
    const placeholder = document.getElementById('qrPlaceholder');
    const loading = document.getElementById('qrLoading');
    const qrImage = document.getElementById('qrImage');
    const connected = document.getElementById('qrConnected');
    
    placeholder.style.display = 'block';
    loading.style.display = 'none';
    qrImage.style.display = 'none';
    connected.style.display = 'none';
}

async function disconnectWhatsApp() {
    if (!sessionId) return;
    
    try {
        await fetch(`${WHATSAPP_SERVICE_URL}/session/${sessionId}/disconnect`, {
            method: 'POST'
        });
        showToast('WhatsApp desconectado');
        resetQRCode();
        updateStatus(false);
    } catch (e) {
        showToast('Erro ao desconectar', 'error');
    }
}

// Verificar status inicial ao carregar
async function checkInitialStatus() {
    try {
        const res = await fetch(`${WHATSAPP_SERVICE_URL}/session/cianet_main/status`);
        const data = await res.json();
        
        if (data.connected) {
            sessionId = 'cianet_main';
            onWhatsAppConnected(data.info);
        }
    } catch (e) {
        console.log('Servi√ßo WhatsApp n√£o dispon√≠vel');
    }
}

// Atualizar URL do webhook dinamicamente
document.getElementById('webhookUrl').value = window.location.origin + '/api/v1/whatsapp/webhook';

loadConfig();
checkInitialStatus();
</script>
<style>@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}</style>
</body>
</html>
