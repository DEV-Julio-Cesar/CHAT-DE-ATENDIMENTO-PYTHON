<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central de Campanhas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --ink: #050304;
            --dark: #0b1221;
            --panel: #101b32;
            --panel-alt: #162447;
            --stroke: rgba(255,255,255,0.08);
            --text: #f4f6ff;
            --muted: #a3b4d7;
            --accent: #6ef3ff;
            --accent-strong: #0ea5e9;
            --warning: #facc15;
            --success: #4ade80;
            --danger: #fb7185;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: 'Space Grotesk', 'Segoe UI', sans-serif;
            background: radial-gradient(circle at top, #141f3f, #050711 65%);
            color: var(--text);
            min-height: 100vh;
            padding: 70px 40px 50px;
        }

        h1, h2, h3 { margin: 0; }

        .page-header {
            margin-bottom: 28px;
        }

        .page-header h1 {
            font-size: 30px;
            letter-spacing: 0.4px;
        }

        .page-header p {
            color: var(--muted);
            margin-top: 8px;
            max-width: 720px;
            line-height: 1.5;
        }

        .layout {
            display: grid;
            grid-template-columns: minmax(320px, 1.2fr) minmax(280px, 1fr);
            gap: 24px;
        }

        .panel {
            background: var(--panel);
            border-radius: 22px;
            padding: 24px;
            border: 1px solid var(--stroke);
            box-shadow: 0 12px 35px rgba(0,0,0,0.3);
        }

        label {
            display: block;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--muted);
            margin-bottom: 8px;
        }

        input[type="text"], textarea, select, input[type="datetime-local"] {
            width: 100%;
            padding: 14px 16px;
            border-radius: 14px;
            border: 1px solid var(--stroke);
            background: var(--panel-alt);
            color: var(--text);
            font-size: 15px;
            font-family: inherit;
        }

        textarea { resize: vertical; min-height: 120px; }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(110,243,255,0.2);
        }

        .field-group { margin-bottom: 22px; }

        .field-hint {
            font-size: 12px;
            color: var(--muted);
            margin-top: 6px;
            opacity: 0.85;
        }

        .planilha-import {
            margin-top: 14px;
            border: 1px dashed rgba(255,255,255,0.15);
            border-radius: 16px;
            padding: 14px 16px;
            background: rgba(6,14,32,0.65);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .planilha-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .planilha-preview {
            font-size: 13px;
            color: var(--muted);
            background: rgba(5,10,24,0.8);
            border-radius: 12px;
            padding: 10px 12px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .chip {
            padding: 10px 18px;
            border-radius: 999px;
            border: 1px solid var(--stroke);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            color: var(--muted);
            transition: all 0.2s ease;
        }

        .chip.active {
            background: rgba(110,243,255,0.12);
            color: var(--accent);
            border-color: var(--accent);
        }

        .toggles {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toggle {
            position: relative;
            width: 56px;
            height: 30px;
        }

        .toggle input { display: none; }

        .toggle span {
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.1);
            border-radius: 999px;
            transition: all 0.2s ease;
        }

        .toggle span::after {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--muted);
            transition: all 0.2s ease;
        }

        .toggle input:checked + span {
            background: rgba(110,243,255,0.25);
        }

        .toggle input:checked + span::after {
            left: 30px;
            background: var(--accent);
        }

        .actions {
            display: flex;
            gap: 14px;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        button {
            border: none;
            border-radius: 999px;
            padding: 12px 26px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        button:disabled { opacity: 0.6; cursor: not-allowed; }

        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9, #6ef3ff);
            color: #020817;
            box-shadow: 0 12px 25px rgba(14,165,233,0.35);
        }

        .btn-secondary {
            background: transparent;
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        .btn-danger { background: rgba(251,113,133,0.18); color: var(--danger); }

        .btn-success {
            background: rgba(74,222,128,0.16);
            color: var(--success);
            border: 1px solid rgba(74,222,128,0.45);
        }

        .ai-card {
            background: var(--panel-alt);
            border-radius: 18px;
            border: 1px solid rgba(255,255,255,0.08);
            padding: 18px;
        }

        .ai-card h3 {
            font-size: 18px;
            margin-bottom: 4px;
        }

        .ai-card p { color: var(--muted); margin-bottom: 12px; }

        .prompt-ia-box {
            background: rgba(6,12,30,0.85);
            border-radius: 14px;
            border: 1px dashed rgba(255,255,255,0.12);
            padding: 16px;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .prompt-ia-texto {
            font-family: 'JetBrains Mono', Consolas, monospace;
            font-size: 13px;
            color: var(--text);
            white-space: pre-wrap;
        }

        .prompt-ia-meta {
            font-size: 12px;
            color: var(--muted);
            margin: 0;
        }

        .preview-box {
            background: #050a18;
            border-radius: 14px;
            padding: 16px;
            font-family: 'JetBrains Mono', Consolas, monospace;
            white-space: pre-wrap;
            min-height: 110px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .listagem {
            margin-top: 32px;
        }

        .listagem-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 18px;
        }

        .campanha-card {
            background: var(--panel);
            border-radius: 18px;
            border: 1px solid transparent;
            padding: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .campanha-card:hover {
            border-color: rgba(110,243,255,0.4);
            transform: translateY(-4px);
        }

        .campanha-card h4 { margin-bottom: 6px; }
        .campanha-card small { color: var(--muted); }

        .history-note {
            font-size: 12px;
            color: var(--muted);
            margin-top: 6px;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 999px;
            background: rgba(255,255,255,0.08);
            font-size: 12px;
            margin-right: 8px;
        }

        .badge.finalidade { background: rgba(110,243,255,0.12); color: var(--accent); }
        .badge.ia { background: rgba(74,222,128,0.16); color: var(--success); }

        .card-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }

        .toast {
            position: fixed;
            bottom: 28px;
            right: 30px;
            padding: 14px 22px;
            border-radius: 999px;
            background: rgba(5,5,12,0.85);
            border: 1px solid var(--stroke);
            color: var(--text);
            box-shadow: 0 10px 25px rgba(0,0,0,0.35);
            z-index: 999;
        }

        @media (max-width: 980px) {
            .layout { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <h1 class="page-header">
        <span style="display:block; font-size:14px; letter-spacing:0.3em; color:var(--muted); text-transform:uppercase;">Operações Omnichannel</span>
        Laboratório de Campanhas Inteligentes
    </h1>
    <p class="page-header">Monte disparos multicanais com mensagens prontas e defina como o Agente de IA deve assumir diálogos complexos logo após o envio.</p>

    <section class="layout">
        <form class="panel" id="formCampanha">
            <div class="field-group">
                <label for="nomeCampanha">Nome da campanha</label>
                <input type="text" id="nomeCampanha" placeholder="Ex.: Reforço de Cobrança Janeiro" required>
            </div>

            <div class="field-group">
                <label for="finalidade">Finalidade principal</label>
                <select id="finalidade">
                    <option value="venda">Venda</option>
                    <option value="cobranca">Cobrança</option>
                    <option value="recolhimento">Recolhimento</option>
                    <option value="instalacoes">Instalações</option>
                    <option value="suporte">Suporte</option>
                    <option value="outro">Outro</option>
                </select>
            </div>

            <div class="field-group">
                <label for="finalidadeDescricao">Descreva a finalidade deste disparo</label>
                <textarea id="finalidadeDescricao" rows="3" placeholder="Ex.: Lembrar clientes sobre o boleto em aberto e propor acordo flexível."></textarea>
            </div>

            <div class="field-group">
                <label>Canais do disparo</label>
                <div class="chips" id="canaisChips">
                    <div class="chip" data-canal="whatsapp">WhatsApp</div>
                    <div class="chip" data-canal="sms">SMS</div>
                    <div class="chip" data-canal="email">E-mail</div>
                    <div class="chip" data-canal="voz">Ligação Assistida</div>
                </div>
            </div>

            <div class="field-group">
                <label for="mensagemBase">Mensagem base</label>
                <textarea id="mensagemBase" placeholder="Texto que será disparado em todos os canais selecionados."></textarea>
            </div>

            <div class="field-group">
                <label for="destinatarios">Destinatários (um por linha)</label>
                <textarea id="destinatarios" rows="4" placeholder="5511999999999&#10;5511988888888"></textarea>
                <p class="field-hint">Inclua o DDI + DDD. Separe utilizando linhas diferentes ou vírgulas.</p>
                <div class="planilha-import">
                    <div>
                        <strong style="font-size:13px; letter-spacing:0.08em; text-transform:uppercase;">Importar planilha Excel</strong>
                        <p class="field-hint" style="margin-top:4px;">Use um arquivo com três colunas (Nome, Telefone, CPF). Apenas a primeira aba será lida.</p>
                    </div>
                    <div class="planilha-actions">
                        <button type="button" class="btn-secondary" id="btnImportPlanilha">Selecionar arquivo (.xlsx)</button>
                        <button type="button" class="btn-secondary" id="btnLimparPlanilha" disabled>Limpar importação</button>
                        <input type="file" id="inputPlanilha" accept=".xlsx,.csv" style="display:none;">
                    </div>
                    <div class="planilha-preview" id="resumoPlanilha">Nenhuma planilha importada.</div>
                </div>
            </div>

            <div class="field-group">
                <label for="clienteWhatsApp">Cliente WhatsApp responsável pelo disparo</label>
                <select id="clienteWhatsApp">
                    <option value="">Automático (primeiro disponível)</option>
                </select>
                <p class="field-hint">Selecione qual sessão conectada enviará a campanha.</p>
            </div>

            <div class="field-group">
                <label for="dataAgendada">Agendar para</label>
                <input type="datetime-local" id="dataAgendada">
            </div>

            <div class="actions">
                <button type="submit" class="btn-primary">Salvar Campanha</button>
                <button type="button" class="btn-success" id="btnDisparar" onclick="dispararCampanhaAtual()">Disparar agora</button>
                <button type="button" class="btn-secondary" onclick="resetarFormulario()">Descartar alterações</button>
            </div>
        </form>

        <div class="panel" style="display:flex; flex-direction:column; gap:16px;">
            <div class="ai-card">
                <h3>Agente de IA no pós-disparo</h3>
                <p>Defina se o bot assume o diálogo após o envio e quais instruções ele deve seguir.</p>
                <div class="toggles">
                    <label style="text-transform:none; letter-spacing:0; color:var(--text);">Ativar agente automático</label>
                    <label class="toggle">
                        <input type="checkbox" id="usarIA" checked>
                        <span></span>
                    </label>
                </div>
                <textarea id="instrucoesIA" rows="6" placeholder="Quando o contato responder, continue pedindo dados e registre interesses. Ofereça humano em caso de objeções."></textarea>
            </div>

            <div class="ai-card">
                <h3>Preview rápido</h3>
                <p>Resumo do disparo consolidado.</p>
                <div class="preview-box" id="previewCampanha">Preencha os campos para visualizar o resumo da campanha.</div>
            </div>
            <div class="ai-card">
                <h3>Plano do agente pós-disparo</h3>
                <p>Assim que o disparo é concluído, geramos o prompt final combinando sua automação com estas instruções.</p>
                <div class="prompt-ia-box">
                    <div id="promptIAResultado" class="prompt-ia-texto">Dispare uma campanha para gerar o script do agente.</div>
                    <p class="prompt-ia-meta" id="promptIAMeta">O agente IA está aguardando o próximo disparo.</p>
                </div>
                <button type="button" class="btn-secondary" id="btnCopiarPrompt" onclick="copiarPromptGerado()" disabled>Copiar prompt</button>
            </div>
        </div>
    </section>

    <section class="listagem">
        <div class="listagem-header">
            <div>
                <h2 style="margin-bottom:4px;">Campanhas salvas</h2>
                <p style="color:var(--muted); margin:0;">Clique em uma campanha para editar ou enviar novamente.</p>
            </div>
            <button class="btn-secondary" onclick="novaCampanha()">Nova campanha</button>
        </div>
        <div class="card-grid" id="campanhasSalvas"></div>
    </section>

    <script>
        let campanhasCache = [];
        let campanhaSelecionada = null;
        let clientesWhatsApp = [];
        const canaisSelecionados = new Set(['whatsapp']);

        const form = document.getElementById('formCampanha');
        const campos = {
            nomeCampanha: document.getElementById('nomeCampanha'),
            finalidade: document.getElementById('finalidade'),
            finalidadeDescricao: document.getElementById('finalidadeDescricao'),
            mensagemBase: document.getElementById('mensagemBase'),
            destinatarios: document.getElementById('destinatarios'),
            clienteWhatsApp: document.getElementById('clienteWhatsApp'),
            dataAgendada: document.getElementById('dataAgendada'),
            usarIA: document.getElementById('usarIA'),
            instrucoesIA: document.getElementById('instrucoesIA')
        };
        const botaoDisparo = document.getElementById('btnDisparar');
        const promptIAResultado = document.getElementById('promptIAResultado');
        const promptIAMeta = document.getElementById('promptIAMeta');
        const botaoCopiarPrompt = document.getElementById('btnCopiarPrompt');
        const importacaoPlanilha = {
            input: document.getElementById('inputPlanilha'),
            resumo: document.getElementById('resumoPlanilha'),
            botaoImportar: document.getElementById('btnImportPlanilha'),
            botaoLimpar: document.getElementById('btnLimparPlanilha')
        };
        let destinatariosDetalhadosAtuais = [];
        let resumoPlanilhaAtual = null;
        let ultimoPromptGerado = null;

        function parseDestinatariosTexto(texto) {
            if (!texto) return [];
            return texto
                .split(/[\n,;]/)
                .map((valor) => valor.trim())
                .map((valor) => valor.replace(/[^0-9]/g, ''))
                .filter((valor) => valor.length >= 8);
        }

        function atualizarBotaoDisparo() {
            if (!botaoDisparo) return;
            botaoDisparo.disabled = !campanhaSelecionada?.id;
        }

        async function carregarClientesWhatsapp() {
            try {
                const resposta = await window.campanhasAPI.listarClientesWhatsapp();
                clientesWhatsApp = Array.isArray(resposta) ? resposta : (resposta?.clients || resposta?.data || []);
            } catch (erro) {
                console.error('Não foi possível carregar clientes WhatsApp:', erro);
                clientesWhatsApp = [];
            }
            preencherSelectClientes();
        }

        function preencherSelectClientes(valorPreferencial) {
            const select = campos.clienteWhatsApp;
            if (!select) return;
            const valorAtual = valorPreferencial ?? select.value;
            select.innerHTML = '<option value="">Automático (primeiro disponível)</option>';
            clientesWhatsApp.forEach((info) => {
                if (!info || !info.clientId) return;
                const option = document.createElement('option');
                option.value = info.clientId;
                const telefone = info.phoneNumber ? `+${info.phoneNumber}` : 'Sem telefone';
                option.textContent = `${info.clientId} · ${info.status || 'desconhecido'} · ${telefone}`;
                select.appendChild(option);
            });
            if (valorAtual) {
                const temValor = Array.from(select.options).some((opt) => opt.value === valorAtual);
                select.value = temValor ? valorAtual : '';
            } else {
                select.value = '';
            }
        }

        function definirLoadingNoBotao(botao, ativo, textoCarregando = 'Processando...') {
            if (!botao) return;
            if (ativo) {
                if (!botao.dataset.originalLabel) {
                    botao.dataset.originalLabel = botao.textContent;
                }
                botao.textContent = textoCarregando;
                botao.disabled = true;
            } else {
                if (botao.dataset.originalLabel) {
                    botao.textContent = botao.dataset.originalLabel;
                    delete botao.dataset.originalLabel;
                }
                botao.disabled = false;
            }
        }

        async function importarPlanilhaSelecionada(evento) {
            const arquivo = evento?.target?.files?.[0];
            if (!arquivo) {
                return;
            }
            if (!arquivo.path) {
                mostrarToast('Não foi possível acessar o arquivo selecionado.', 'error');
                return;
            }

            definirLoadingNoBotao(importacaoPlanilha.botaoImportar, true, 'Importando...');
            try {
                const resposta = await window.campanhasAPI.importarPlanilha({ filePath: arquivo.path });
                if (resposta?.success) {
                    destinatariosDetalhadosAtuais = Array.isArray(resposta.contatos) ? resposta.contatos : [];
                    const numeros = Array.isArray(resposta.destinatarios) && resposta.destinatarios.length > 0
                        ? resposta.destinatarios
                        : destinatariosDetalhadosAtuais.map((contato) => contato.telefone).filter(Boolean);
                    campos.destinatarios.value = numeros.join('\n');
                    resumoPlanilhaAtual = {
                        arquivo: arquivo.name,
                        total: resposta.total || destinatariosDetalhadosAtuais.length
                    };
                    atualizarResumoPlanilha();
                    atualizarPreview();
                    mostrarToast(`Importamos ${destinatariosDetalhadosAtuais.length} contato(s).`, 'success');
                } else {
                    mostrarToast(resposta?.message || 'Falha ao importar planilha.', 'error');
                }
            } catch (erro) {
                console.error('Erro ao importar planilha:', erro);
                mostrarToast('Erro ao ler o arquivo selecionado.', 'error');
            } finally {
                definirLoadingNoBotao(importacaoPlanilha.botaoImportar, false);
            }
        }

        function atualizarResumoPlanilha() {
            if (!importacaoPlanilha.resumo) return;
            if (!destinatariosDetalhadosAtuais.length) {
                importacaoPlanilha.resumo.textContent = 'Nenhuma planilha importada.';
                if (importacaoPlanilha.botaoLimpar) {
                    importacaoPlanilha.botaoLimpar.disabled = true;
                }
                return;
            }

            const total = resumoPlanilhaAtual?.total || destinatariosDetalhadosAtuais.length;
            const arquivo = resumoPlanilhaAtual?.arquivo;
            const exemplos = destinatariosDetalhadosAtuais
                .slice(0, 3)
                .map((contato) => {
                    const partes = [];
                    if (contato.nome) partes.push(contato.nome);
                    if (contato.telefone) partes.push(`tel: ${contato.telefone}`);
                    if (contato.cpf) partes.push(`CPF: ${contato.cpf}`);
                    return partes.join(' | ');
                })
                .filter(Boolean)
                .join(' • ');

            let mensagem = `${total} contato(s) importados`;
            if (arquivo) mensagem += ` de ${arquivo}`;
            mensagem += '.';
            if (exemplos) mensagem += ` Exemplos: ${exemplos}.`;
            importacaoPlanilha.resumo.textContent = mensagem;

            if (importacaoPlanilha.botaoLimpar) {
                importacaoPlanilha.botaoLimpar.disabled = false;
            }
        }

        function limparImportacaoPlanilha() {
            if (!destinatariosDetalhadosAtuais.length) {
                mostrarToast('Nenhum contato importado para limpar.', 'info');
                return;
            }
            destinatariosDetalhadosAtuais = [];
            resumoPlanilhaAtual = null;
            atualizarResumoPlanilha();
            mostrarToast('Importação limpa. Ajuste os destinatários manualmente, se necessário.', 'info');
        }

        document.getElementById('canaisChips').addEventListener('click', (event) => {
            const chip = event.target.closest('.chip');
            if (!chip) return;
            const canal = chip.dataset.canal;
            if (canaisSelecionados.has(canal)) {
                canaisSelecionados.delete(canal);
            } else {
                canaisSelecionados.add(canal);
            }
            if (canaisSelecionados.size === 0) {
                canaisSelecionados.add('whatsapp');
            }
            sincronizarChips();
            atualizarPreview();
        });

        ['nomeCampanha','finalidade','finalidadeDescricao','mensagemBase','dataAgendada','destinatarios'].forEach((key) => {
            campos[key].addEventListener('input', atualizarPreview);
        });
        campos.clienteWhatsApp.addEventListener('change', atualizarPreview);
        campos.usarIA.addEventListener('change', () => {
            atualizarPreview();
            if (!ultimoPromptGerado) {
                atualizarPromptGerado();
            }
        });
        campos.instrucoesIA.addEventListener('input', atualizarPreview);

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            await salvarCampanha();
        });

        if (importacaoPlanilha.botaoImportar && importacaoPlanilha.input) {
            importacaoPlanilha.botaoImportar.addEventListener('click', () => {
                importacaoPlanilha.input.value = '';
                importacaoPlanilha.input.click();
            });
        }

        if (importacaoPlanilha.input) {
            importacaoPlanilha.input.addEventListener('change', importarPlanilhaSelecionada);
        }

        if (importacaoPlanilha.botaoLimpar) {
            importacaoPlanilha.botaoLimpar.addEventListener('click', limparImportacaoPlanilha);
        }

        function sincronizarChips() {
            document.querySelectorAll('.chip').forEach((chip) => {
                chip.classList.toggle('active', canaisSelecionados.has(chip.dataset.canal));
            });
        }

        function montarPayload() {
            return {
                id: campanhaSelecionada?.id,
                nome: campos.nomeCampanha.value.trim(),
                finalidade: campos.finalidade.value,
                finalidadeDescricao: campos.finalidadeDescricao.value.trim(),
                canais: Array.from(canaisSelecionados),
                mensagemBase: campos.mensagemBase.value.trim(),
                agendadoPara: campos.dataAgendada.value ? new Date(campos.dataAgendada.value).toISOString() : null,
                destinatarios: parseDestinatariosTexto(campos.destinatarios.value),
                destinatariosDetalhados: destinatariosDetalhadosAtuais,
                clientePreferencial: campos.clienteWhatsApp.value || null,
                usarAgenteIA: campos.usarIA.checked,
                instrucoesIA: campos.instrucoesIA.value.trim()
            };
        }

        async function salvarCampanha({ silencioso = false } = {}) {
            const payload = montarPayload();
            if (!payload.nome) {
                if (!silencioso) mostrarToast('Informe um nome para a campanha.', 'warning');
                return false;
            }
            if (!payload.mensagemBase) {
                if (!silencioso) mostrarToast('Escreva a mensagem base antes de salvar.', 'warning');
                return false;
            }
            const resultado = await window.campanhasAPI.salvar(payload);
            if (resultado?.success) {
                if (!silencioso) mostrarToast('Campanha salva com sucesso!', 'success');
                campanhaSelecionada = resultado.campanha;
                atualizarBotaoDisparo();
                await carregarCampanhas();
                return true;
            } else {
                if (!silencioso) mostrarToast(resultado?.message || 'Falha ao salvar campanha.', 'error');
                return false;
            }
        }

        async function lidarComRetornoDisparo(resposta) {
            if (resposta?.success) {
                const enviados = resposta.enviados ?? 0;
                const falhas = resposta.falhas ?? 0;
                const status = resposta.status || 'executado';
                mostrarToast(`Disparo ${status} · ${enviados} envio(s), ${falhas} falha(s).`, 'success');
                if (resposta.ia?.ativa && resposta.ia?.prompt) {
                    atualizarPromptGerado({
                        prompt: resposta.ia.prompt,
                        timestamp: resposta.ia.geradoEm,
                        status
                    });
                } else if (!resposta.ia?.ativa) {
                    atualizarPromptGerado();
                }
                await carregarCampanhas();
                if (campanhaSelecionada?.id === resposta.campanhaId) {
                    const atualizada = campanhasCache.find((c) => c.id === resposta.campanhaId);
                    if (atualizada) {
                        campanhaSelecionada = atualizada;
                        destinatariosDetalhadosAtuais = Array.isArray(atualizada.destinatariosDetalhados) ? atualizada.destinatariosDetalhados : destinatariosDetalhadosAtuais;
                        resumoPlanilhaAtual = destinatariosDetalhadosAtuais.length ? { total: destinatariosDetalhadosAtuais.length } : null;
                        atualizarResumoPlanilha();
                        atualizarPromptComHistorico(atualizada);
                    }
                }
            } else {
                mostrarToast(resposta?.message || 'Falha ao iniciar disparo.', 'error');
            }
        }

        async function dispararCampanhaAtual() {
            if (!campanhaSelecionada?.id) {
                mostrarToast('Salve a campanha antes de disparar.', 'warning');
                return;
            }
            const salvou = await salvarCampanha({ silencioso: true });
            if (!salvou) return;
            if (!confirm('Deseja iniciar o disparo desta campanha agora?')) return;
            definirLoadingNoBotao(botaoDisparo, true, 'Disparando...');
            try {
                const resposta = await window.campanhasAPI.disparar({ campanhaId: campanhaSelecionada.id });
                await lidarComRetornoDisparo(resposta);
            } finally {
                definirLoadingNoBotao(botaoDisparo, false);
                atualizarBotaoDisparo();
            }
        }

        window.dispararCampanha = async function(evt, id) {
            const campanha = campanhasCache.find((c) => c.id === id);
            if (!campanha) {
                mostrarToast('Campanha não encontrada.', 'error');
                return;
            }
            if (!confirm(`Deseja iniciar o disparo da campanha "${campanha.nome}"?`)) return;
            const botao = evt?.currentTarget || evt?.target;
            definirLoadingNoBotao(botao, true, 'Disparando...');
            try {
                const resposta = await window.campanhasAPI.disparar({ campanhaId: campanha.id });
                await lidarComRetornoDisparo(resposta);
            } finally {
                definirLoadingNoBotao(botao, false);
            }
        };

        async function carregarCampanhas() {
            const resposta = await window.campanhasAPI.listar();
            campanhasCache = resposta?.campanhas || [];
            renderizarCampanhas();
            if (campanhaSelecionada) {
                const encontrada = campanhasCache.find((c) => c.id === campanhaSelecionada.id) || null;
                if (encontrada) {
                    campanhaSelecionada = encontrada;
                    atualizarPromptComHistorico(encontrada);
                }
            }
        }

        function renderizarCampanhas() {
            const container = document.getElementById('campanhasSalvas');
            if (campanhasCache.length === 0) {
                container.innerHTML = '<div class="campanha-card" style="text-align:center; color:var(--muted);">Nenhuma campanha cadastrada. Crie a primeira agora.</div>';
                return;
            }
            container.innerHTML = campanhasCache.map((campanha) => {
                const canais = campanha.canais?.join(', ') || 'whatsapp';
                const ultimaExecucao = campanha.historicoEnvios?.[0]?.dataExecucao;
                const totalDestinatarios = campanha.destinatarios?.length || 0;
                const totalDetalhados = campanha.destinatariosDetalhados?.length || 0;
                const resumoDetalhados = totalDetalhados ? ` · Dados completos: ${totalDetalhados}` : '';
                return `
                    <div class="campanha-card" onclick="editarCampanha('${campanha.id}')">
                        <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:6px;">
                            <div class="badge finalidade">${formatarFinalidade(campanha.finalidade)}</div>
                            ${campanha.usarAgenteIA !== false ? '<div class="badge ia">IA ativa</div>' : ''}
                        </div>
                        <h4>${campanha.nome}</h4>
                        <small>${campanha.finalidadeDescricao || 'Sem descrição'}</small>
                        <p style="margin:12px 0 0; color:var(--muted); font-size:13px;">${canais.toUpperCase()}</p>
                        <p class="history-note">Destinatários: ${totalDestinatarios}${resumoDetalhados} · Último disparo: ${formatarDataCurta(ultimaExecucao)}</p>
                        <div class="card-actions">
                            <button class="btn-success" style="padding:6px 14px; font-size:13px;" onclick="event.stopPropagation(); dispararCampanha(event, '${campanha.id}')">Disparar</button>
                            <button class="btn-secondary" style="padding:6px 14px; font-size:13px;" onclick="event.stopPropagation(); editarCampanha('${campanha.id}')">Editar</button>
                            <button class="btn-danger" style="padding:6px 14px; font-size:13px;" onclick="event.stopPropagation(); removerCampanha('${campanha.id}')">Excluir</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function atualizarPromptComHistorico(campanha) {
            const ultimoHistorico = campanha?.historicoEnvios?.[0];
            if (ultimoHistorico?.promptIA) {
                atualizarPromptGerado({
                    prompt: ultimoHistorico.promptIA,
                    timestamp: ultimoHistorico.dataExecucao,
                    status: ultimoHistorico.status
                });
            } else {
                atualizarPromptGerado();
            }
        }

        function atualizarPromptGerado(info) {
            if (!promptIAResultado || !promptIAMeta) return;
            if (!info?.prompt) {
                ultimoPromptGerado = null;
                promptIAResultado.textContent = 'Dispare uma campanha para gerar o script do agente.';
                promptIAMeta.textContent = campos.usarIA.checked
                    ? 'O agente IA está aguardando o próximo disparo.'
                    : 'O agente IA está desativado para esta campanha.';
                if (botaoCopiarPrompt) botaoCopiarPrompt.disabled = true;
                return;
            }

            ultimoPromptGerado = info;
            promptIAResultado.textContent = info.prompt;
            const partesMeta = [];
            if (info.timestamp) partesMeta.push(`Gerado em ${formatarDataCurta(info.timestamp)}`);
            if (info.status) partesMeta.push(`Status: ${info.status.toUpperCase()}`);
            promptIAMeta.textContent = partesMeta.join(' · ') || 'Prompt pronto para o agente IA.';
            if (botaoCopiarPrompt) botaoCopiarPrompt.disabled = false;
        }

        window.copiarPromptGerado = async function() {
            if (!ultimoPromptGerado?.prompt) return;
            try {
                if (navigator?.clipboard?.writeText) {
                    await navigator.clipboard.writeText(ultimoPromptGerado.prompt);
                } else {
                    const textarea = document.createElement('textarea');
                    textarea.value = ultimoPromptGerado.prompt;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    textarea.remove();
                }
                mostrarToast('Prompt copiado para a área de transferência.', 'success');
            } catch (erro) {
                console.error('Erro ao copiar prompt:', erro);
                mostrarToast('Não foi possível copiar o prompt.', 'error');
            }
        };

        window.editarCampanha = function(id) {
            const campanha = campanhasCache.find((c) => c.id === id);
            if (!campanha) return;
            campanhaSelecionada = campanha;
            preencherFormulario(campanha);
            mostrarToast('Campanha carregada para edição.', 'info');
        };

        window.removerCampanha = async function(id) {
            if (!confirm('Deseja realmente excluir esta campanha?')) return;
            const resultado = await window.campanhasAPI.remover(id);
            if (resultado?.success) {
                mostrarToast('Campanha removida.', 'success');
                if (campanhaSelecionada?.id === id) {
                    campanhaSelecionada = null;
                    novaCampanha();
                }
                await carregarCampanhas();
            } else {
                mostrarToast(resultado?.message || 'Erro ao remover campanha.', 'error');
            }
        };

        function preencherFormulario(campanha) {
            campos.nomeCampanha.value = campanha.nome || '';
            campos.finalidade.value = campanha.finalidade || 'venda';
            campos.finalidadeDescricao.value = campanha.finalidadeDescricao || '';
            campos.mensagemBase.value = campanha.mensagemBase || '';
            campos.destinatarios.value = (campanha.destinatarios || []).join('\n');
            campos.dataAgendada.value = campanha.agendadoPara ? campanha.agendadoPara.slice(0, 16) : '';
            preencherSelectClientes(campanha.clientePreferencial || '');
            campos.clienteWhatsApp.value = campanha.clientePreferencial || '';
            campos.usarIA.checked = campanha.usarAgenteIA !== false;
            campos.instrucoesIA.value = campanha.instrucoesIA || '';
            destinatariosDetalhadosAtuais = Array.isArray(campanha.destinatariosDetalhados) ? campanha.destinatariosDetalhados : [];
            resumoPlanilhaAtual = destinatariosDetalhadosAtuais.length ? { total: destinatariosDetalhadosAtuais.length } : null;
            canaisSelecionados.clear();
            (campanha.canais || ['whatsapp']).forEach((canal) => canaisSelecionados.add(canal));
            sincronizarChips();
            atualizarPreview();
            atualizarBotaoDisparo();
            atualizarResumoPlanilha();
            atualizarPromptComHistorico(campanha);
        }

        function atualizarPreview() {
            const resumo = montarPayload();
            const linhas = [];
            linhas.push(`Campanha: ${resumo.nome || 'sem título'}`);
            linhas.push(`Finalidade: ${formatarFinalidade(resumo.finalidade)}${resumo.finalidadeDescricao ? ' - ' + resumo.finalidadeDescricao : ''}`);
            linhas.push(`Canais: ${resumo.canais.join(', ')}`);
            linhas.push(`Destinatários planejados: ${resumo.destinatarios.length}`);
            if (destinatariosDetalhadosAtuais.length) {
                linhas.push(`Contatos com dados completos: ${destinatariosDetalhadosAtuais.length}`);
            }
            if (resumo.agendadoPara) {
                linhas.push(`Agendado para: ${formatarDataCurta(resumo.agendadoPara)}`);
            }
            linhas.push(`Cliente WhatsApp: ${resumo.clientePreferencial || 'Automático'}`);
            linhas.push(`Mensagem base:\n${resumo.mensagemBase || '---'}`);
            if (resumo.usarAgenteIA) {
                linhas.push(`Agente IA ativo -> ${resumo.instrucoesIA || 'Sem instruções.'}`);
            } else {
                linhas.push('Agente IA desativado para esta campanha.');
            }
            document.getElementById('previewCampanha').textContent = linhas.join('\n\n');
        }

        function formatarFinalidade(valor) {
            const mapa = {
                venda: 'Vendas',
                cobranca: 'Cobranças',
                recolhimento: 'Recolhimentos',
                instalacoes: 'Instalações',
                suporte: 'Suporte',
                outro: 'Outros'
            };
            return mapa[valor] || 'Outro';
        }

        function formatarDataCurta(valor) {
            if (!valor) return 'Nunca';
            const data = new Date(valor);
            if (Number.isNaN(data.getTime())) {
                return 'Nunca';
            }
            return data.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function mostrarToast(mensagem, tipo = 'info') {
            const cores = {
                success: 'var(--success)',
                error: 'var(--danger)',
                warning: 'var(--warning)',
                info: 'var(--accent)'
            };
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.borderColor = cores[tipo] || 'var(--stroke)';
            toast.style.color = cores[tipo] || 'var(--text)';
            toast.textContent = mensagem;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3200);
        }

        function resetarFormulario() {
            if (campanhaSelecionada) {
                preencherFormulario(campanhaSelecionada);
            } else {
                novaCampanha();
            }
        }

        function novaCampanha() {
            campanhaSelecionada = null;
            campos.nomeCampanha.value = '';
            campos.finalidade.value = 'venda';
            campos.finalidadeDescricao.value = '';
            campos.mensagemBase.value = '';
            campos.destinatarios.value = '';
            campos.dataAgendada.value = '';
            preencherSelectClientes('');
            campos.clienteWhatsApp.value = '';
            campos.usarIA.checked = true;
            campos.instrucoesIA.value = '';
            destinatariosDetalhadosAtuais = [];
            resumoPlanilhaAtual = null;
            canaisSelecionados.clear();
            canaisSelecionados.add('whatsapp');
            sincronizarChips();
            atualizarResumoPlanilha();
            atualizarPromptGerado();
            atualizarPreview();
            atualizarBotaoDisparo();
        }

        window.novaCampanha = novaCampanha;

        (async function inicializar() {
            sincronizarChips();
            await carregarClientesWhatsapp();
            novaCampanha();
            await carregarCampanhas();
        })();
    </script>

    <script src="barra-navegacao.js"></script>
    <script>
        initNavigationBar('Campanhas Omnichannel');
    </script>
</body>
</html>
