<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat WhatsApp - Sistema de Filas</title>
    <style>
        :root {
            --bg: #f0f2f5;
            --panel: #ffffff;
            --header: #00897b;
            --text: #333333;
            --text-secondary: #666666;
            --border: #e0e0e0;
            --bubble-received: #ffffff;
            --bubble-sent: #dcf8c6;
            --input-bg: #f5f5f5;
            --btn-primary: #00897b;
            --btn-hover: #00695c;
            --tab-active: #00897b;
            --badge-automacao: #3b82f6;
            --badge-espera: #f59e0b;
            --badge-atendimento: #10b981;
            --scrollbar: #cccccc;
            --scrollbar-thumb: #888888;
            --selection-bar: #4CAF50;
            --checkbox-checked: #00897b;
        }

        [data-theme="Escuro"] {
            --bg: #111b21;
            --panel: #202c33;
            --header: #00695c;
            --text: #e9edef;
            --text-secondary: #8696a0;
            --border: #2a3942;
            --bubble-received: #202c33;
            --bubble-sent: #005c4b;
            --input-bg: #2a3942;
            --scrollbar: #374045;
            --scrollbar-thumb: #56666f;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* SIDEBAR */
        .sidebar {
            width: 380px;
            background: var(--panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            background: var(--header);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .attendant-panel {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--panel);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .attendant-meta {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-secondary);
            letter-spacing: 0.08em;
            font-weight: 600;
        }

        .attendant-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
        }

        .attendant-status-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .attendant-status-badge {
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            background: var(--badge-atendimento);
            transition: background 0.2s ease;
        }

        .attendant-status-badge.ocupado {
            background: var(--badge-espera);
        }

        .attendant-status-select {
            flex: 1;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--input-bg);
            color: var(--text);
            font-weight: 500;
            cursor: pointer;
        }

        .sidebar-header h2 {
            font-size: 18px;
            font-weight: 500;
        }

        .btn-refresh {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .btn-refresh:hover {
            background: rgba(255,255,255,0.1);
        }

        /* TABS */
        .tabs {
            display: flex;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
        }

        .tab {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            position: relative;
            font-size: 13px;
        }

        .tab:hover {
            background: rgba(0, 168, 132, 0.05);
        }

        .tab.active {
            border-bottom-color: var(--tab-active);
            font-weight: 600;
        }

        .tab-icon {
            font-size: 18px;
            display: block;
            margin-bottom: 4px;
        }

        .tab-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--badge-automacao);
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: bold;
            min-width: 18px;
        }

        .tab[data-tab="automacao"] .tab-badge { background: var(--badge-automacao); }
        .tab[data-tab="espera"] .tab-badge { background: var(--badge-espera); }
        .tab[data-tab="atendimento"] .tab-badge { background: var(--badge-atendimento); }

        /* SEARCH */
        .search-container {
            padding: 10px 15px;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
        }

        .search-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: var(--input-bg);
            color: var(--text);
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--btn-primary);
        }

        /* SELECTION BAR */
        .selection-bar {
            display: none;
            background: var(--selection-bar);
            color: white;
            padding: 12px 20px;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
        }

        .selection-bar.active {
            display: flex;
        }

        .selection-info {
            font-size: 14px;
            font-weight: 500;
        }

        .selection-actions {
            display: flex;
            gap: 10px;
        }

        .selection-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 6px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .selection-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .selection-btn.danger {
            background: #f44336;
            border-color: #d32f2f;
        }

        .selection-btn.danger:hover {
            background: #d32f2f;
        }

        /* CHAT LIST */
        .chat-list-container {
            flex: 1;
            overflow-y: auto;
        }

        .chat-list-container::-webkit-scrollbar {
            width: 6px;
        }

        .chat-list-container::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 3px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .chat-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .chat-item:hover {
            background: rgba(0, 168, 132, 0.05);
        }

        .chat-item.selected {
            background: rgba(0, 168, 132, 0.1);
        }

        .chat-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--checkbox-checked);
            margin-top: 2px;
        }

        .chat-item-content {
            flex: 1;
            min-width: 0;
        }

        .chat-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .chat-name {
            font-weight: 600;
            font-size: 15px;
            color: var(--text);
        }

        .chat-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .chat-preview {
            font-size: 13px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 6px;
        }

        .chat-meta {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .status-badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-automacao { background: var(--badge-automacao); color: white; }
        .status-espera { background: var(--badge-espera); color: white; }
        .status-atendimento { background: var(--badge-atendimento); color: white; }

        .tentativas-badge {
            background: #ff9800;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }

        .atendente-badge {
            background: #9c27b0;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
        }

        .chat-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .btn-action {
            padding: 5px 12px;
            border: 1px solid var(--border);
            background: var(--panel);
            color: var(--text);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .btn-action:hover {
            background: var(--btn-primary);
            color: white;
            border-color: var(--btn-primary);
        }

        .btn-assumir {
            background: var(--badge-atendimento);
            color: white;
            border-color: var(--badge-atendimento);
        }

        .btn-assumir:hover {
            background: #0d9668;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* CHAT AREA */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #e5ddd5;
        }

        [data-theme="Escuro"] .chat-area {
            background: #0b141a;
        }

        .chat-header {
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .chat-contact-avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: var(--border);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
        }

        .chat-contact-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .chat-contact-initials {
            font-size: 18px;
            font-weight: 600;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .chat-contact-avatar.has-photo img {
            display: block;
        }

        .chat-contact-avatar.has-photo .chat-contact-initials {
            display: none;
        }

        .chat-contact-wa-name {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .chat-header-info h3 {
            font-size: 16px;
            margin-bottom: 3px;
        }

        .chat-header-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .chat-header-actions {
            display: flex;
            gap: 10px;
        }

        .btn-header {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: var(--panel);
            color: var(--text);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .btn-header:hover {
            background: var(--btn-primary);
            color: white;
            border-color: var(--btn-primary);
        }

        .btn-encerrar {
            background: #f44336;
            color: white;
            border-color: #f44336;
        }

        .btn-encerrar:hover {
            background: #d32f2f;
        }

        .btn-transferir {
            background: #ff9800;
            color: white;
            border-color: #ff9800;
        }

        .btn-transferir:hover {
            background: #f57c00;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .messages-container::-webkit-scrollbar {
            width: 8px;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 4px;
        }

        .message {
            margin-bottom: 12px;
            display: flex;
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 60%;
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .message.received .message-bubble {
            background: var(--bubble-received);
        }

        .message.sent .message-bubble {
            background: var(--bubble-sent);
        }

        .message-text {
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 4px;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: right;
        }

        .input-area {
            background: var(--panel);
            border-top: 1px solid var(--border);
            padding: 15px 20px;
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px 18px;
            border: 1px solid var(--border);
            border-radius: 25px;
            background: var(--input-bg);
            color: var(--text);
            font-size: 14px;
            resize: none;
            max-height: 100px;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--btn-primary);
        }

        .btn-send {
            background: var(--btn-primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .btn-send:hover {
            background: var(--btn-hover);
        }

        .empty-chat {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: var(--text-secondary);
        }

        .empty-chat-icon {
            font-size: 72px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* MODAL */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--panel);
            border-radius: 8px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .btn-close:hover {
            background: rgba(0,0,0,0.1);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-select, .form-textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
        }

        .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--btn-primary);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-modal {
            padding: 10px 20px;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-cancel {
            background: var(--panel);
            color: var(--text);
        }

        .btn-cancel:hover {
            background: var(--input-bg);
        }

        .btn-confirm {
            background: var(--btn-primary);
            color: white;
            border-color: var(--btn-primary);
        }

        .btn-confirm:hover {
            background: var(--btn-hover);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Filas de Atendimento</h2>
                <button class="btn-refresh" onclick="carregarFilas()"> Atualizar</button>
            </div>

            <div class="attendant-panel">
                <div>
                    <div class="attendant-meta">Atendente logado</div>
                    <div class="attendant-name" id="attendantName">—</div>
                </div>
                <div class="attendant-status-row">
                    <span class="attendant-status-badge" id="attendantStatusBadge">Disponível</span>
                    <select class="attendant-status-select" id="attendantStatusSelect">
                        <option value="disponivel">Disponível</option>
                        <option value="ocupado">Ocupado</option>
                    </select>
                </div>
            </div>

            <!-- TABS -->
            <div class="tabs">
                <div class="tab active" data-tab="automacao" onclick="trocarAba('automacao')">
                    <span class="tab-icon"></span>
                    <span>Automação</span>
                    <span class="tab-badge" id="badge-automacao">0</span>
                </div>
                <div class="tab" data-tab="espera" onclick="trocarAba('espera')">
                    <span class="tab-icon"></span>
                    <span>Em Espera</span>
                    <span class="tab-badge" id="badge-espera">0</span>
                </div>
                <div class="tab" data-tab="atendimento" onclick="trocarAba('atendimento')">
                    <span class="tab-icon"></span>
                    <span>Meus Atendimentos</span>
                    <span class="tab-badge" id="badge-atendimento">0</span>
                </div>
            </div>

            <!-- SEARCH -->
            <div class="search-container">
                <input type="text" class="search-input" placeholder=" Buscar conversa..." id="searchInput" oninput="filtrarConversas()">
            </div>

            <!-- SELECTION BAR -->
            <div class="selection-bar" id="selectionBar">
                <div class="selection-info">
                    <span id="selectedCount">0</span> selecionadas
                </div>
                <div class="selection-actions">
                    <button class="selection-btn" onclick="abrirModalAtribuirMultiplos()"> Atribuir</button>
                    <button class="selection-btn danger" onclick="abrirModalEncerrarMultiplos()"> Encerrar</button>
                    <button class="selection-btn" onclick="limparSelecao()">Cancelar</button>
                </div>
            </div>

            <!-- CHAT LISTS -->
            <div class="chat-list-container">
                <div class="tab-content active" id="lista-automacao"></div>
                <div class="tab-content" id="lista-espera"></div>
                <div class="tab-content" id="lista-atendimento"></div>
            </div>
        </div>

        <!-- CHAT AREA -->
        <div class="chat-area" id="chatArea">
            <div class="empty-chat">
                <div class="empty-chat-icon"></div>
                <p>Selecione uma conversa para começar</p>
            </div>
        </div>
    </div>

    <!-- MODAL TRANSFERIR -->
    <div class="modal-overlay" id="modalTransferir">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Transferir Atendimento</h3>
                <button class="btn-close" onclick="fecharModal('modalTransferir')"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Transferir para:</label>
                    <select class="form-select" id="transferirAtendente">
                        <option value="">Selecione um atendente...</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-cancel" onclick="fecharModal('modalTransferir')">Cancelar</button>
                <button class="btn-modal btn-confirm" onclick="confirmarTransferencia()">Transferir</button>
            </div>
        </div>
    </div>

    <!-- MODAL ATRIBUIR -->
    <div class="modal-overlay" id="modalAtribuir">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Atribuir Atendimento</h3>
                <button class="btn-close" onclick="fecharModal('modalAtribuir')"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Atribuir para:</label>
                    <input type="text" class="form-select" id="atribuirAtendente" placeholder="Nome do atendente">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-cancel" onclick="fecharModal('modalAtribuir')">Cancelar</button>
                <button class="btn-modal btn-confirm" onclick="confirmarAtribuicao()">Atribuir</button>
            </div>
        </div>
    </div>

    <!-- MODAL ATRIBUIR MÚLTIPLOS -->
    <div class="modal-overlay" id="modalAtribuirMultiplos">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Atribuir Múltiplas Conversas</h3>
                <button class="btn-close" onclick="fecharModal('modalAtribuirMultiplos')"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Atribuir <span id="countAtribuir">0</span> conversas para:</label>
                    <input type="text" class="form-select" id="atribuirMultiplosAtendente" placeholder="Nome do atendente">
                </div>
                <div class="form-group">
                    <label class="form-label">Mensagem (opcional):</label>
                    <textarea class="form-textarea" id="atribuirMultiplosMensagem" placeholder="Mensagem que será enviada para todos os clientes..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-cancel" onclick="fecharModal('modalAtribuirMultiplos')">Cancelar</button>
                <button class="btn-modal btn-confirm" onclick="confirmarAtribuirMultiplos()">Atribuir Todos</button>
            </div>
        </div>
    </div>

    <!-- MODAL ENCERRAR MÚLTIPLOS -->
    <div class="modal-overlay" id="modalEncerrarMultiplos">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Encerrar Múltiplas Conversas</h3>
                <button class="btn-close" onclick="fecharModal('modalEncerrarMultiplos')"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Encerrar <span id="countEncerrar">0</span> conversas</label>
                    <textarea class="form-textarea" id="encerrarMultiplosMensagem" placeholder="Mensagem de despedida que será enviada para todos os clientes..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-cancel" onclick="fecharModal('modalEncerrarMultiplos')">Cancelar</button>
                <button class="btn-modal btn-confirm" onclick="confirmarEncerrarMultiplos()">Encerrar Todos</button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = 'Administrador';
        let currentClientId = null;
        let attendantStatus = 'disponivel';
        let contatoAtual = null;
        let conversasCache = { automacao: [], espera: [], atendimento: [] };
        let abaAtual = 'automacao';
        let conversaAtual = null;
        let conversasSelecionadas = new Set();

        async function inicializarContextoAtendente() {
            if (!currentUser) {
                atualizarPainelAtendente();
                return;
            }

            if (!window.electronAPI?.attend) {
                atualizarPainelAtendente();
                return;
            }

            try {
                await window.electronAPI.attend.register(currentUser);
                const resposta = await window.electronAPI.attend.getStatus(currentUser);
                attendantStatus = resposta?.status || 'disponivel';
            } catch (error) {
                console.warn('Erro ao sincronizar status do atendente:', error);
                attendantStatus = 'disponivel';
            }

            atualizarPainelAtendente();
        }

        function atualizarPainelAtendente() {
            const nomeEl = document.getElementById('attendantName');
            if (nomeEl) {
                nomeEl.textContent = currentUser || '—';
            }

            const badgeEl = document.getElementById('attendantStatusBadge');
            if (badgeEl) {
                const disponivel = attendantStatus !== 'ocupado';
                badgeEl.textContent = disponivel ? 'Disponível' : 'Ocupado';
                badgeEl.classList.toggle('ocupado', !disponivel);
            }

            const selectEl = document.getElementById('attendantStatusSelect');
            if (selectEl && selectEl.value !== attendantStatus) {
                selectEl.value = attendantStatus;
            }
        }

        async function alterarStatusAtendente(novoStatus) {
            if (!window.electronAPI?.attend || !currentUser) {
                return;
            }

            const statusNormalizado = novoStatus === 'ocupado' ? 'ocupado' : 'disponivel';

            try {
                const resultado = await window.electronAPI.attend.setStatus({
                    username: currentUser,
                    status: statusNormalizado
                });

                if (resultado?.success) {
                    attendantStatus = statusNormalizado;
                    atualizarPainelAtendente();
                    mostrarToast(` Status atualizado para ${statusNormalizado === 'ocupado' ? 'ocupado' : 'disponível'}`, 'Sucesso');
                } else {
                    mostrarToast(resultado?.message || ' Não foi possível atualizar o status', 'Erro');
                    atualizarPainelAtendente();
                }
            } catch (error) {
                console.error('Erro ao atualizar status do atendente:', error);
                mostrarToast(' Erro ao atualizar status', 'Erro');
                atualizarPainelAtendente();
            }
        }

        const statusSelectEl = document.getElementById('attendantStatusSelect');
        if (statusSelectEl) {
            statusSelectEl.addEventListener('change', (event) => {
                alterarStatusAtendente(event.target.value);
            });
        }

        function gerarIniciaisContato(nome = '') {
            const base = (nome || '').trim();
            if (!base) return '??';

            const partes = base.split(/\s+/).filter(Boolean);
            if (!partes.length) {
                return base.slice(0, 2).toUpperCase();
            }

            return partes.slice(0, 2).map(parte => parte[0].toUpperCase()).join('');
        }

        function extrairNumeroWhatsApp(identificador = '') {
            if (!identificador) return '';
            return identificador.includes('@') ? identificador.split('@')[0] : identificador;
        }

        function construirContatoFallback(nome, chatId) {
            return {
                nome: nome || 'Contato WhatsApp',
                numero: extrairNumeroWhatsApp(chatId),
                pushname: '',
                businessName: '',
                foto: ''
            };
        }

        function atualizarAvatarContato(info = {}) {
            const avatarEl = document.getElementById('contactAvatar');
            const avatarImg = document.getElementById('contactAvatarImage');
            const avatarFallback = document.getElementById('contactAvatarFallback');

            if (!avatarEl || !avatarImg || !avatarFallback) return;

            if (info.foto) {
                avatarImg.src = info.foto;
                avatarImg.style.display = 'block';
                avatarFallback.style.display = 'none';
                avatarEl.classList.add('has-photo');
            } else {
                avatarImg.src = '';
                avatarImg.style.display = 'none';
                avatarFallback.textContent = gerarIniciaisContato(info.nome || info.numero || '??');
                avatarFallback.style.display = 'flex';
                avatarEl.classList.remove('has-photo');
            }
        }

        function atualizarHeaderContato(info = {}) {
            const nameEl = document.getElementById('contactName');
            const metaEl = document.getElementById('contactMeta');
            const waNameEl = document.getElementById('contactWaName');

            if (nameEl) {
                nameEl.textContent = info.nome || info.pushname || 'Contato WhatsApp';
            }

            if (metaEl) {
                const partesMeta = [];
                if (info.numero) partesMeta.push(info.numero);
                if (info.businessName) partesMeta.push(info.businessName);
                else if (info.pushname) partesMeta.push(info.pushname);
                metaEl.textContent = partesMeta.length ? `WhatsApp • ${partesMeta.join(' • ')}` : 'WhatsApp';
            }

            if (waNameEl) {
                const alias = info.businessName || info.pushname || '';
                waNameEl.textContent = alias;
                waNameEl.style.display = alias ? 'block' : 'none';
            }

            atualizarAvatarContato(info);
        }

        function atualizarMetaConversa(conversa, estado, tempoDecorrido) {
            const metaEl = document.getElementById('conversationMeta');
            if (!metaEl) return;

            const estadoTexto = estado === 'automacao'
                ? 'Automação'
                : estado === 'espera'
                    ? 'Em espera'
                    : 'Em atendimento';

            const tentativas = conversa.tentativasBot > 0
                ? `${conversa.tentativasBot} tentativa${conversa.tentativasBot > 1 ? 's' : ''} bot • `
                : '';

            metaEl.textContent = `Estado: ${estadoTexto} • ${tentativas}Criado há ${tempoDecorrido}`;
        }

        async function sincronizarContatoWhatsApp(clientId, chatId, nomeFallback) {
            const fallback = construirContatoFallback(nomeFallback, chatId);

            if (!window.chatAPI?.obterContato) {
                contatoAtual = fallback;
                atualizarHeaderContato(contatoAtual);
                return;
            }

            try {
                const resposta = await window.chatAPI.obterContato(clientId, chatId);

                if (!conversaAtual || conversaAtual.clientId !== clientId || conversaAtual.chatId !== chatId) {
                    return;
                }

                if (resposta?.success && resposta.contato) {
                    const contato = resposta.contato;
                    contatoAtual = {
                        nome: contato.nome || fallback.nome,
                        numero: contato.numero || fallback.numero,
                        pushname: contato.pushname || '',
                        businessName: contato.businessName || '',
                        foto: contato.foto || ''
                    };
                } else {
                    contatoAtual = fallback;
                    if (resposta?.message) {
                        console.warn('Contato WhatsApp:', resposta.message);
                    }
                }
            } catch (error) {
                if (conversaAtual?.clientId !== clientId || conversaAtual?.chatId !== chatId) {
                    return;
                }
                console.warn('Erro ao carregar contato WhatsApp:', error);
                contatoAtual = fallback;
            }

            atualizarHeaderContato(contatoAtual);
        }

        // Recebe clientId dos parâmetros de navegação
        if (window.navigationAPI) {
            window.navigationAPI.onParams((params) => {
                if (params.usuario) {
                    currentUser = params.usuario;
                }

                if (params.clientId) {
                    currentClientId = params.clientId;
                }

                inicializarContextoAtendente();
                carregarFilas();
            });
        }

        inicializarContextoAtendente();

        async function carregarFilas() {
            try {
                const [automacao, espera, atendimento] = await Promise.all([
                    window.filasAPI.listarPorEstado('automacao'),
                    window.filasAPI.listarPorEstado('espera'),
                    window.filasAPI.listarPorEstado('atendimento', currentUser)
                ]);

                conversasCache = { automacao, espera, atendimento };

                document.getElementById('badge-automacao').textContent = automacao.length;
                document.getElementById('badge-espera').textContent = espera.length;
                document.getElementById('badge-atendimento').textContent = atendimento.length;

                renderizarLista('automacao', automacao);
                renderizarLista('espera', espera);
                renderizarLista('atendimento', atendimento);

            } catch (error) {
                console.error('Erro ao carregar filas:', error);
            }
        }

        function trocarAba(aba) {
            abaAtual = aba;
            
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('Ativo'));
            document.querySelector(`.tab[data-tab="${aba}"]`).classList.add('Ativo');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('Ativo'));
            document.getElementById(`lista-${aba}`).classList.add('Ativo');

            limparSelecao();
        }

        function renderizarLista(estado, conversas) {
            const container = document.getElementById(`lista-${estado}`);
            
            if (conversas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <p>Nenhuma conversa nesta fila</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = conversas.map(c => {
                const tempo = calcularTempoDecorrido(c.atualizadoEm);
                const statusClass = `status-${estado}`;
                const statusText = estado === 'automacao' ? 'Bot' : 
                                 estado === 'espera' ? 'Aguardando' : 'Em Atendimento';
                
                let actionsHtml = '';
                
                if (estado === 'espera') {
                    actionsHtml = `
                        <div class="chat-actions">
                            <button class="btn-action btn-assumir" onclick="assumirConversa(event, '${c.clientId}', '${c.chatId}')"> Assumir</button>
                            <button class="btn-action" onclick="abrirModalAtribuirConversa(event, '${c.clientId}', '${c.chatId}')"> Atribuir a...</button>
                        </div>
                    `;
                } else if (estado === 'automacao') {
                    actionsHtml = `
                        <div class="chat-actions">
                            <button class="btn-action" onclick="escalarParaHumano(event, '${c.clientId}', '${c.chatId}')"> Escalar</button>
                            <button class="btn-action" onclick="abrirModalAtribuirConversa(event, '${c.clientId}', '${c.chatId}')"> Atribuir a...</button>
                        </div>
                    `;
                }

                const tentativasBadge = c.tentativasBot > 0 ? 
                    `<span class="tentativas-badge">${c.tentativasBot} tent.</span>` : '';
                
                const atendenteBadge = c.atendente ? 
                    `<span class="atendente-badge"> ${c.atendente}</span>` : '';

                const isSelected = conversasSelecionadas.has(c.id);

                return `
                    <div class="chat-item ${isSelected ? 'selected' : ''}" data-id="${c.id}">
                        <input type="checkbox" class="chat-checkbox" 
                               onchange="toggleSelecao('${c.id}')" 
                               ${isSelected ? 'checked' : ''}>
                        <div class="chat-item-content" onclick="abrirConversa('${c.clientId}', '${c.chatId}', '${estado}')">
                            <div class="chat-item-header">
                                <span class="chat-name">${c.metadata.nomeContato}</span>
                                <span class="chat-time">${tempo}</span>
                            </div>
                            <div class="chat-preview">${c.metadata.ultimaMensagem}</div>
                            <div class="chat-meta">
                                <span class="status-badge ${statusClass}">${statusText}</span>
                                ${tentativasBadge}
                                ${atendenteBadge}
                            </div>
                            ${actionsHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleSelecao(id) {
            if (conversasSelecionadas.has(id)) {
                conversasSelecionadas.delete(id);
            } else {
                conversasSelecionadas.add(id);
            }
            atualizarBarraSelecao();
        }

        function atualizarBarraSelecao() {
            const count = conversasSelecionadas.size;
            const bar = document.getElementById('selectionBar');
            const countSpan = document.getElementById('selectedCount');

            if (count > 0) {
                bar.classList.add('Ativo');
                countSpan.textContent = count;
            } else {
                bar.classList.remove('Ativo');
            }

            document.querySelectorAll('.chat-item').forEach(item => {
                const id = item.dataset.id;
                if (conversasSelecionadas.has(id)) {
                    item.classList.add('selected');
                    item.querySelector('.chat-checkbox').checked = true;
                } else {
                    item.classList.remove('selected');
                    item.querySelector('.chat-checkbox').checked = false;
                }
            });
        }

        function limparSelecao() {
            conversasSelecionadas.clear();
            document.querySelectorAll('.chat-checkbox').forEach(cb => cb.checked = false);
            atualizarBarraSelecao();
        }

        async function assumirConversa(event, clientId, chatId) {
            event.stopPropagation();
            
            try {
                const result = await window.filasAPI.assumirConversa(clientId, chatId, currentUser);
                if (result.success) {
                    await carregarFilas();
                    trocarAba('atendimento');
                    abrirConversa(clientId, chatId, 'atendimento');
                    mostrarToast(' Conversa assumida com sucesso!', 'Sucesso');
                } else {
                    mostrarToast(' ' + result.message, 'Erro');
                }
            } catch (error) {
                console.error('Erro ao assumir conversa:', error);
                mostrarToast(' Erro ao assumir conversa', 'Erro');
            }
        }

        async function escalarParaHumano(event, clientId, chatId) {
            event.stopPropagation();
            
            if (!confirm('Escalar esta conversa para atendimento humano?')) return;

            try {
                const result = await window.filasAPI.moverParaEspera(clientId, chatId, 'escalado_manualmente');
                if (result.success) {
                    await carregarFilas();
                    mostrarToast(' Conversa escalada para fila de espera', 'Sucesso');
                } else {
                    mostrarToast(' ' + result.message, 'Erro');
                }
            } catch (error) {
                console.error('Erro ao escalar conversa:', error);
                mostrarToast(' Erro ao escalar conversa', 'Erro');
            }
        }

        async function abrirConversa(clientId, chatId, estado) {
            conversaAtual = { clientId, chatId, estado };
            
            const conversa = conversasCache[estado].find(c => c.clientId === clientId && c.chatId === chatId);
            if (!conversa) return;

            let mensagens = [];
            try {
                const historico = await window.chatAPI.carregarHistorico(clientId, chatId);
                mensagens = historico.mensagens || [];
            } catch (error) {
                console.error('Erro ao carregar histórico:', error);
            }

            const chatArea = document.getElementById('chatArea');
            const tempo = calcularTempoDecorrido(conversa.criadoEm);
            const nomeContato = conversa?.metadata?.nomeContato || extrairNumeroWhatsApp(chatId);
            contatoAtual = construirContatoFallback(nomeContato, chatId);
            const iniciaisContato = gerarIniciaisContato(contatoAtual.nome || contatoAtual.numero || '??');
            
            let headerActions = '';
            if (estado === 'atendimento') {
                headerActions = `
                    <button class="btn-header btn-transferir" onclick="abrirModalTransferir()">Transferir</button>
                    <button class="btn-header btn-encerrar" onclick="encerrarAtendimento()">Encerrar</button>
                `;
            } else if (estado === 'espera') {
                headerActions = `
                    <button class="btn-header btn-assumir" onclick="assumirConversa(event, '${clientId}', '${chatId}')"> Assumir</button>
                `;
            } else if (estado === 'automacao') {
                headerActions = `
                    <button class="btn-header" onclick="escalarParaHumano(event, '${clientId}', '${chatId}')"> Escalar</button>
                `;
            }

            chatArea.innerHTML = `
                <div class="chat-header">
                    <div class="chat-header-left">
                        <div class="chat-contact-avatar" id="contactAvatar">
                            <img id="contactAvatarImage" alt="Foto do contato" />
                            <span class="chat-contact-initials" id="contactAvatarFallback">${iniciaisContato}</span>
                        </div>
                        <div class="chat-header-info">
                            <h3 id="contactName">${contatoAtual.nome}</h3>
                            <div class="chat-contact-wa-name" id="contactWaName" style="display:none;"></div>
                            <div class="chat-header-meta" id="contactMeta">${contatoAtual.numero ? `WhatsApp • ${contatoAtual.numero}` : 'Sincronizando com WhatsApp...'}</div>
                            <div class="chat-header-meta" id="conversationMeta"></div>
                        </div>
                    </div>
                    <div class="chat-header-actions">
                        ${headerActions}
                    </div>
                </div>
                <div class="messages-container" id="messagesContainer">
                    ${mensagens.map(m => `
                        <div class="message ${m.fromMe ? 'Enviado' : 'Recebido'}">
                            <div class="message-bubble">
                                <div class="message-text">${m.body}</div>
                                <div class="message-time">${formatarHora(m.timestamp)}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="input-area">
                    <textarea class="message-input" id="messageInput" placeholder="Digite sua mensagem..." onkeypress="handleEnter(event)"></textarea>
                    <button class="btn-send" onclick="enviarMensagem()">Enviar</button>
                </div>
            `;

            const container = document.getElementById('messagesContainer');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }

            atualizarMetaConversa(conversa, estado, tempo);
            sincronizarContatoWhatsApp(clientId, chatId, contatoAtual.nome);
        }

        function handleEnter(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                enviarMensagem();
            }
        }

        async function enviarMensagem() {
            if (!conversaAtual) return;

            const input = document.getElementById('messageInput');
            const mensagem = input.value.trim();
            
            if (!mensagem) return;

            try {
                await window.chatAPI.enviarMensagem(conversaAtual.clientId, conversaAtual.chatId, mensagem);
                input.value = '';
                
                setTimeout(() => {
                    abrirConversa(conversaAtual.clientId, conversaAtual.chatId, conversaAtual.estado);
                }, 500);
            } catch (error) {
                console.error('Erro ao enviar mensagem:', error);
                mostrarToast(' Erro ao enviar mensagem', 'Erro');
            }
        }

        async function encerrarAtendimento() {
            if (!conversaAtual) return;

            if (!confirm('Deseja realmente encerrar este atendimento?')) return;

            try {
                const result = await window.filasAPI.encerrarConversa(conversaAtual.clientId, conversaAtual.chatId, currentUser);
                if (result.success) {
                    await carregarFilas();
                    document.getElementById('chatArea').innerHTML = `
                        <div class="empty-chat">
                            <div class="empty-chat-icon"></div>
                            <p>Selecione uma conversa para começar</p>
                        </div>
                    `;
                    conversaAtual = null;
                    mostrarToast(' Atendimento encerrado!', 'Sucesso');
                } else {
                    mostrarToast(' ' + result.message, 'Erro');
                }
            } catch (error) {
                console.error('Erro ao encerrar:', error);
                mostrarToast(' Erro ao encerrar atendimento', 'Erro');
            }
        }

        // MODAIS
        async function abrirModalTransferir() {
            const modal = document.getElementById('modalTransferir');
            const select = document.getElementById('transferirAtendente');
            
            const atendentes = await window.filasAPI.listarAtendentes();
            select.innerHTML = '<option value="">Selecione um atendente...</option>';
            atendentes.forEach(a => {
                if (a !== currentUser) {
                    select.innerHTML += `<option value="${a}">${a}</option>`;
                }
            });
            
            modal.classList.add('Ativo');
        }

        async function confirmarTransferencia() {
            if (!conversaAtual) return;
            
            const atendenteDestino = document.getElementById('transferirAtendente').value;
            if (!atendenteDestino) {
                alert('Selecione um atendente');
                return;
            }

            try {
                const result = await window.filasAPI.transferirConversa(
                    conversaAtual.clientId,
                    conversaAtual.chatId,
                    atendenteDestino,
                    currentUser
                );

                if (result.success) {
                    fecharModal('modalTransferir');
                    await carregarFilas();
                    document.getElementById('chatArea').innerHTML = `
                        <div class="empty-chat">
                            <div class="empty-chat-icon"></div>
                            <p>Selecione uma conversa para começar</p>
                        </div>
                    `;
                    conversaAtual = null;
                    mostrarToast(` Conversa transferida para ${atendenteDestino}!`, 'Sucesso');
                } else {
                    mostrarToast(' ' + result.message, 'Erro');
                }
            } catch (error) {
                console.error('Erro ao transferir:', error);
                mostrarToast(' Erro ao transferir conversa', 'Erro');
            }
        }

        function abrirModalAtribuirConversa(event, clientId, chatId) {
            event.stopPropagation();
            conversaAtual = { clientId, chatId };
            document.getElementById('modalAtribuir').classList.add('Ativo');
        }

        async function confirmarAtribuicao() {
            if (!conversaAtual) return;
            
            const atendente = document.getElementById('atribuirAtendente').value.trim();
            if (!atendente) {
                alert('Digite o nome do atendente');
                return;
            }

            try {
                const result = await window.filasAPI.atribuirConversa(
                    conversaAtual.clientId,
                    conversaAtual.chatId,
                    atendente,
                    currentUser
                );

                if (result.success) {
                    fecharModal('modalAtribuir');
                    await carregarFilas();
                    mostrarToast(` Conversa atribuída para ${atendente}!`, 'Sucesso');
                } else {
                    mostrarToast(' ' + result.message, 'Erro');
                }
            } catch (error) {
                console.error('Erro ao atribuir:', error);
                mostrarToast(' Erro ao atribuir conversa', 'Erro');
            }
        }

        function abrirModalAtribuirMultiplos() {
            if (conversasSelecionadas.size === 0) {
                alert('Selecione conversas primeiro');
                return;
            }
            document.getElementById('countAtribuir').textContent = conversasSelecionadas.size;
            document.getElementById('modalAtribuirMultiplos').classList.add('Ativo');
        }

        async function confirmarAtribuirMultiplos() {
            const atendente = document.getElementById('atribuirMultiplosAtendente').value.trim();
            const mensagem = document.getElementById('atribuirMultiplosMensagem').value.trim();
            
            if (!atendente) {
                alert('Digite o nome do atendente');
                return;
            }

            try {
                const ids = Array.from(conversasSelecionadas);
                const result = await window.filasAPI.atribuirMultiplos(ids, atendente, currentUser);

                if (mensagem && result.success) {
                    for (const r of result.resultados.filter(r => r.success)) {
                        const conversa = [...conversasCache.automacao, ...conversasCache.espera, ...conversasCache.atendimento]
                            .find(c => c.id === r.id);
                        if (conversa) {
                            try {
                                await window.chatAPI.enviarMensagem(conversa.clientId, conversa.chatId, mensagem);
                            } catch (err) {
                                console.error('Erro ao enviar mensagem:', err);
                            }
                        }
                    }
                }

                fecharModal('modalAtribuirMultiplos');
                limparSelecao();
                await carregarFilas();
                
                const sucesso = result.resultados.filter(r => r.success).length;
                mostrarToast(` ${sucesso} conversas atribuídas para ${atendente}!`, 'Sucesso');
            } catch (error) {
                console.error('Erro:', error);
                mostrarToast(' Erro ao atribuir conversas', 'Erro');
            }
        }

        function abrirModalEncerrarMultiplos() {
            if (conversasSelecionadas.size === 0) {
                alert('Selecione conversas primeiro');
                return;
            }
            document.getElementById('countEncerrar').textContent = conversasSelecionadas.size;
            document.getElementById('modalEncerrarMultiplos').classList.add('Ativo');
        }

        async function confirmarEncerrarMultiplos() {
            const mensagem = document.getElementById('encerrarMultiplosMensagem').value.trim();

            if (!confirm(`Encerrar ${conversasSelecionadas.size} conversas?`)) return;

            try {
                const ids = Array.from(conversasSelecionadas);
                
                if (mensagem) {
                    for (const id of ids) {
                        const conversa = [...conversasCache.automacao, ...conversasCache.espera, ...conversasCache.atendimento]
                            .find(c => c.id === id);
                        if (conversa) {
                            try {
                                await window.chatAPI.enviarMensagem(conversa.clientId, conversa.chatId, mensagem);
                            } catch (err) {
                                console.error('Erro ao enviar mensagem:', err);
                            }
                        }
                    }
                }

                const result = await window.filasAPI.encerrarMultiplos(ids, currentUser);

                fecharModal('modalEncerrarMultiplos');
                limparSelecao();
                await carregarFilas();
                
                const sucesso = result.resultados.filter(r => r.success).length;
                mostrarToast(` ${sucesso} conversas encerradas!`, 'Sucesso');
            } catch (error) {
                console.error('Erro:', error);
                mostrarToast(' Erro ao encerrar conversas', 'Erro');
            }
        }

        function fecharModal(id) {
            document.getElementById(id).classList.remove('Ativo');
        }

        function filtrarConversas() {
            const termo = document.getElementById('searchInput').value.toLowerCase();
            const conversas = conversasCache[abaAtual];
            
            if (!termo) {
                renderizarLista(abaAtual, conversas);
                return;
            }

            const filtradas = conversas.filter(c => 
                c.metadata.nomeContato.toLowerCase().includes(termo) ||
                c.metadata.ultimaMensagem.toLowerCase().includes(termo)
            );

            renderizarLista(abaAtual, filtradas);
        }

        function calcularTempoDecorrido(timestamp) {
            const agora = new Date();
            const data = new Date(timestamp);
            const diff = Math.floor((agora - data) / 1000);

            if (diff < 60) return `${diff}s`;
            if (diff < 3600) return `${Math.floor(diff / 60)}min`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h`;
            return `${Math.floor(diff / 86400)}d`;
        }

        function formatarHora(timestamp) {
            const data = new Date(timestamp * 1000);
            return data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        function mostrarToast(mensagem, tipo) {
            console.log(`[${tipo}] ${mensagem}`);
        }

        setInterval(carregarFilas, 30000);

        if (window.chatAPI) {
            window.chatAPI.aoNovaMensagem(async (data) => {
                await carregarFilas();
                if (conversaAtual && conversaAtual.chatId === data.chatId) {
                    abrirConversa(conversaAtual.clientId, conversaAtual.chatId, conversaAtual.estado);
                }
            });
        }

        setTimeout(carregarFilas, 500);
    </script>
</body>
</html>
